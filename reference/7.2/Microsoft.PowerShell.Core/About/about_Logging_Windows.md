---
description: PowerShell регистрирует внутренние операции из подсистемы, поставщиков и командлетов в журнале событий Windows.
Locale: en-US
ms.date: 03/30/2020
online version: https://docs.microsoft.com/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.2&WT.mc_id=ps-gethelp
schema: 2.0.0
title: about_Logging — Windows
ms.openlocfilehash: d6ae50b50911417da8dd306cad69e3fc7129fedc
ms.sourcegitcommit: 95d41698c7a2450eeb70ef2fb6507fe7e6eff3b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "99600168"
---
# <a name="about-logging-windows"></a>Сведения о окнах ведения журнала

## <a name="short-description"></a>Краткое описание
PowerShell регистрирует внутренние операции из подсистемы, поставщиков и командлетов в журнале событий Windows.

## <a name="long-description"></a>Подробное описание

PowerShell регистрирует сведения об операциях PowerShell, таких как запуск и остановка подсистемы и поставщиков, а также выполнение команд PowerShell.

> [!NOTE]
> В Windows PowerShell версии 3,0, 4,0, 5,0 и 5,1 включены командлеты **EventLog** для журналов событий Windows. В этих версиях для вывода списка типов командлетов **EventLog** : `Get-Command -Noun EventLog` . Дополнительные сведения см. в документации по командлетам и about_EventLogs для вашей версии Windows PowerShell.

## <a name="viewing-the-powershell-event-log-entries-on-windows"></a>Просмотр записей журнала событий PowerShell в Windows

Журналы PowerShell можно просмотреть с помощью Просмотр событий Windows. Журнал событий находится в группе Журналы приложений и служб и называется `PowerShellCore` . Связанным поставщиком ETW `GUID` является `{f90714a8-5509-434a-bf6d-b1624c8a19a2}` .

Если включено ведение журнала блокировки сценариев, PowerShell регистрирует в журнале следующие события `PowerShellCore/Operational` :

|  Поле  |       Значение       |
| ------- | ----------------- |
| EventId | `4104` / `0x1008` |
| Канал | `Operational`     |
| Уровень   | `Verbose`         |
| Код операции  | `Create`          |
| Задача    | `CommandStart`    |
| Ключевое слово | `Runspace`        |

### <a name="registering-the-powershell-event-provider-on-windows"></a>Регистрация поставщика событий PowerShell в Windows

В отличие от Linux или macOS, Windows требует регистрации поставщика событий, прежде чем события могут быть записаны в журнал событий. Чтобы включить поставщик событий PowerShell, выполните следующую команду в командной строке PowerShell с повышенными привилегиями.

```powershell
$PSHOME\RegisterManifest.ps1
```

### <a name="unregistering-the-powershell-event-provider-on-windows"></a>Отмена регистрации поставщика событий PowerShell в Windows

Регистрация поставщика событий помещает блокировку в двоичную библиотеку, используемую для расшифровки событий. Чтобы обновить эту библиотеку, необходимо отменить регистрацию поставщика, чтобы освободить эту блокировку.

Чтобы отменить регистрацию поставщика PowerShell, выполните следующую команду в командной строке PowerShell с повышенными привилегиями.

```powershell
$PSHOME\RegisterManifest.ps1 -Unregister
```

После обновления PowerShell выполните команду, `$PSHOME\RegisterManifest.ps1` чтобы зарегистрировать обновленный поставщик событий.

## <a name="enabling-script-block-logging"></a>Включение ведения журнала блоков сценариев

При включении ведения журнала блока сценариев PowerShell записывает содержимое всех блоков сценариев, которые он обрабатывает. После включения все новые сеансы PowerShell регистрируют эти сведения.

> [!NOTE]
> Рекомендуется включить ведение журнала защищенных событий, как описано ниже, при использовании журнала блокировки сценариев для любых операций, кроме целей диагностики.

Ведение журнала блока скрипта можно включить с помощью групповая политика или параметра реестра.

### <a name="using-group-policy"></a>Использование групповой политики

Чтобы включить автоматическую транскрипцию, включите эту `Turn on PowerShell Script Block
Logging` функцию в групповая политика с помощью `Administrative Templates -> Windows
Components -> Windows PowerShell` .

### <a name="using-the-registry"></a>Использование реестра

Выполните следующую функцию:

```powershell
function Enable-PSScriptBlockLogging
{
    $basePath = 'HKLM:\Software\Policies\Microsoft\Windows' +
      '\PowerShell\ScriptBlockLogging'

    if(-not (Test-Path $basePath))
    {
        $null = New-Item $basePath -Force
    }

    Set-ItemProperty $basePath -Name EnableScriptBlockLogging -Value "1"
}
```

## <a name="protected-event-logging"></a>Ведение журнала защищенных событий

Увеличение уровня ведения журналов в системе повышает вероятность того, что содержимое журнала может содержать конфиденциальные данные. Например, если включено ведение журнала сценариев, то учетные данные или другие конфиденциальные данные, используемые сценарием, могут быть записаны в журнал событий. При компрометации компьютера, на котором зарегистрированы конфиденциальные данные, журналы могут предоставить злоумышленнику информацию, необходимую для расширения их доступности.

Для защиты этих сведений в Windows 10 появился журнал защищенных событий.
Защищенное ведение журнала событий позволяет участвующим приложениям шифровать конфиденциальные данные, записанные в журнал событий. Позже вы сможете расшифровать и обработать эти журналы на более безопасном и централизованном сборщике журналов.

Содержимое журнала событий защищено с помощью стандартного синтаксиса сообщений (CMS) IETF. CMS использует шифрование с открытым ключом. Ключи, используемые для шифрования содержимого и расшифровки содержимого, хранятся отдельно.

Открытый ключ может быть общим и не конфиденциальным. Любое содержимое, зашифрованное с помощью этого открытого ключа, может быть расшифровано только закрытым ключом. Дополнительные сведения о шифровании с открытым ключом см. в статье о [шифровании с открытым ключом Википедии](https://en.wikipedia.org/wiki/Public-key_cryptography).

Чтобы включить политику защищенного ведения журнала событий, разверните открытый ключ для всех компьютеров, которые содержат данные журнала событий для защиты. Соответствующий закрытый ключ используется для последующей обработки журналов событий в более безопасном расположении, например в центральном сборщике журналов событий или [SIEM][] агрегаторе. Вы можете настроить SIEM в Azure. Дополнительные сведения см. в разделе [Универсальная интеграция SIEM](/cloud-app-security/siem).

### <a name="enabling-protected-event-logging-via-group-policy"></a>Включение ведения журнала защищенных событий с помощью групповая политика

Чтобы включить ведение журнала защищенных событий, включите `Enable Protected Event Logging` функцию в групповая политика с помощью `Administrative Templates -> Windows Components
-> Event Logging` . Для этого параметра требуется сертификат шифрования, который можно указать в одной из следующих форм:

- Содержимое сертификата X. 509 в кодировке Base-64 (например, предложено `Export` параметром в диспетчере сертификатов).
- Отпечаток сертификата, который можно найти в хранилище сертификатов локального компьютера (может быть развернут инфраструктурой PKI).
- Полный путь к сертификату (может быть локальным или удаленным общим ресурсом).
- Путь к каталогу, содержащему сертификат или сертификаты (может быть локальным или удаленным общим ресурсом).
- Имя субъекта сертификата, который можно найти в хранилище сертификатов локального компьютера (может быть развернуто инфраструктурой PKI).

Итоговый сертификат должен иметь `Document Encryption` в качестве расширенного использования ключа ( `1.3.6.1.4.1.311.80.1` ), а `Data Encipherment` также значение или `Key
Encipherment` Использование ключей.

> [!WARNING]
> Закрытый ключ не должен быть развернут на компьютерах, регистрируемых в журнале событий. Он должен храниться в безопасном месте, где вы расшифровываете сообщения.

### <a name="decrypting-protected-event-logging-messages"></a>Расшифровка сообщений журнала защищенных событий

Следующий сценарий будет получен и расшифрован, предполагая, что у вас есть закрытый ключ:

```powershell
Get-WinEvent Microsoft-Windows-PowerShell/Operational |
  Where-Object Id -eq 4104 | Unprotect-CmsMessage
```

## <a name="see-also"></a>См. также

[about_Logging_Non — Windows](about_Logging_Non-Windows.md)

[PowerShell — Синяя команда](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/)

[Универсальная интеграция SIEM](/cloud-app-security/siem)

<!-- link references -->
[SIEM]: https://wikipedia.org/wiki/Security_information_and_event_management

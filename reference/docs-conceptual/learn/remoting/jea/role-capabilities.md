---
ms.date: 07/10/2019
keywords: jea,powershell,безопасность
title: Возможности ролей JEA
description: Возможность роли — это файл данных PowerShell с расширением PSRC, содержащий все командлеты, функции, поставщики и внешние программы, которые должны быть доступны для подключающихся пользователей.
ms.openlocfilehash: 233d9081f4a8f977f0959addb5573c4566f885d0
ms.sourcegitcommit: ba7315a496986451cfc1296b659d73ea2373d3f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "92500000"
---
# <a name="jea-role-capabilities"></a><span data-ttu-id="80ff4-104">Возможности ролей JEA</span><span class="sxs-lookup"><span data-stu-id="80ff4-104">JEA Role Capabilities</span></span>

<span data-ttu-id="80ff4-105">При создании конечной точки JEA потребуется определить одну или несколько "возможностей ролей", описывающих, что именно пользователь может сделать в сеансе JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-105">When creating a JEA endpoint, you need to define one or more role capabilities that describe what someone can do in a JEA session.</span></span> <span data-ttu-id="80ff4-106">Возможность роли — это файл данных PowerShell с расширением `.psrc`, содержащий все командлеты, функции, поставщики и внешние программы, которые должны быть доступны для подключающихся пользователей.</span><span class="sxs-lookup"><span data-stu-id="80ff4-106">A role capability is a PowerShell data file with the `.psrc` extension that lists all the cmdlets, functions, providers, and external programs that are made available to connecting users.</span></span>

## <a name="determine-which-commands-to-allow"></a><span data-ttu-id="80ff4-107">Определение разрешаемых команд</span><span class="sxs-lookup"><span data-stu-id="80ff4-107">Determine which commands to allow</span></span>

<span data-ttu-id="80ff4-108">Прежде всего, при создании файла возможности роли нужно определить, к чему именно потребуется доступ пользователям.</span><span class="sxs-lookup"><span data-stu-id="80ff4-108">The first step in creating a role capability file is to consider what the users need access to.</span></span> <span data-ttu-id="80ff4-109">Этот процесс сбора требований может занять некоторое время, однако он крайне важен.</span><span class="sxs-lookup"><span data-stu-id="80ff4-109">The requirements gathering process can take a while, but it's an important process.</span></span> <span data-ttu-id="80ff4-110">Предоставление пользователям доступа к слишком малому набору командлетов и функций может помешать их нормальной работе.</span><span class="sxs-lookup"><span data-stu-id="80ff4-110">Giving users access to too few cmdlets and functions can prevent them from getting their job done.</span></span> <span data-ttu-id="80ff4-111">Открыв доступ к слишком большому числу командлетов и функций, вы можете предоставить пользователям больше возможностей, чем предусмотрено, тем самым понизив уровень вашей безопасности.</span><span class="sxs-lookup"><span data-stu-id="80ff4-111">Allowing access to too many cmdlets and functions can allow users to do more than you intended and weaken your security stance.</span></span>

<span data-ttu-id="80ff4-112">То, как вы будете это делать, зависит от вашей организации и целей.</span><span class="sxs-lookup"><span data-stu-id="80ff4-112">How you go about this process depends on your organization and goals.</span></span> <span data-ttu-id="80ff4-113">Следующие советы помогут убедиться, что вы встали на правильный путь.</span><span class="sxs-lookup"><span data-stu-id="80ff4-113">The following tips can help ensure you're on the right path.</span></span>

1. <span data-ttu-id="80ff4-114">**Определите**, какие команды пользователи применяют для выполнения поставленных задач.</span><span class="sxs-lookup"><span data-stu-id="80ff4-114">**Identify** the commands users are using to get their jobs done.</span></span> <span data-ttu-id="80ff4-115">Для этого можно опросить ИТ-специалистов, проверить сценарии автоматизации либо проанализировать журналы или записи сеансов PowerShell.</span><span class="sxs-lookup"><span data-stu-id="80ff4-115">This may involve surveying IT staff, checking automation scripts, or analyzing PowerShell session transcripts and logs.</span></span>
2. <span data-ttu-id="80ff4-116">По возможности **замените** используемые программы командной строки на эквиваленты PowerShell, чтобы сделать аудит и настройку JEA максимально удобными.</span><span class="sxs-lookup"><span data-stu-id="80ff4-116">**Update** use of command-line tools to PowerShell equivalents, where possible, for the best auditing and JEA customization experience.</span></span> <span data-ttu-id="80ff4-117">Внешние программы не поддерживают такую детальную настройку ограничений, как собственные командлеты PowerShell и функции в JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-117">External programs can't be constrained as granularly as native PowerShell cmdlets and functions in JEA.</span></span>
3. <span data-ttu-id="80ff4-118">**Ограничьте** область действия командлетов, разрешив только отдельные параметры и их значения.</span><span class="sxs-lookup"><span data-stu-id="80ff4-118">**Restrict** the scope of the cmdlets to only allow specific parameters or parameter values.</span></span> <span data-ttu-id="80ff4-119">Это особенно важно в том случае, если пользователи должны управлять только частью системы.</span><span class="sxs-lookup"><span data-stu-id="80ff4-119">This is especially important if users should manage only part of a system.</span></span>
4. <span data-ttu-id="80ff4-120">**Создайте** настраиваемые функции на замену сложным командам или командам, которые трудно ограничить в JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-120">**Create** custom functions to replace complex commands or commands that are difficult to constrain in JEA.</span></span> <span data-ttu-id="80ff4-121">Простая функция, включающая в себя сложную команду или применяющая дополнительную логику проверки, повышает уровень контроля и упрощает работу администраторов и конечных пользователей.</span><span class="sxs-lookup"><span data-stu-id="80ff4-121">A simple function that wraps a complex command or applies additional validation logic can offer additional control for admins and end-user simplicity.</span></span>
5. <span data-ttu-id="80ff4-122">**Проверьте** полученный список допустимых команд на соответствие потребностям пользователей или служб автоматизации и при необходимости скорректируйте его.</span><span class="sxs-lookup"><span data-stu-id="80ff4-122">**Test** the scoped list of allowable commands with your users or automation services, and adjust as necessary.</span></span>

### <a name="examples-of-potentially-dangerous-commands"></a><span data-ttu-id="80ff4-123">Примеры потенциально опасных команд</span><span class="sxs-lookup"><span data-stu-id="80ff4-123">Examples of potentially dangerous commands</span></span>

<span data-ttu-id="80ff4-124">Важно тщательно отбирать команды, чтобы конечная точка JEA не позволяла пользователю повысить свои права.</span><span class="sxs-lookup"><span data-stu-id="80ff4-124">Careful selection of commands is important to ensure the JEA endpoint doesn't allow the user to elevate their permissions.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="80ff4-125">Важные сведения, необходимые для успеха пользователя: команды в сеансе JEA часто запускаются с повышенными привилегиями.</span><span class="sxs-lookup"><span data-stu-id="80ff4-125">Essential information required for user successCommands in a JEA session are often run with elevated privileges.</span></span>

<span data-ttu-id="80ff4-126">В таблице ниже приведено несколько примеров команд, которые в состоянии без ограничений быть использованы злоумышленниками.</span><span class="sxs-lookup"><span data-stu-id="80ff4-126">The following table contains examples of commands that can be used maliciously if allowed in an unconstrained state.</span></span> <span data-ttu-id="80ff4-127">Этот список не является исчерпывающим и служит лишь отправной точкой для дальнейших действий.</span><span class="sxs-lookup"><span data-stu-id="80ff4-127">This isn't an exhaustive list and should only be used as a cautionary starting point.</span></span>

|                                            <span data-ttu-id="80ff4-128">Риск</span><span class="sxs-lookup"><span data-stu-id="80ff4-128">Risk</span></span>                                            |                                <span data-ttu-id="80ff4-129">Пример</span><span class="sxs-lookup"><span data-stu-id="80ff4-129">Example</span></span>                                |                                                                              <span data-ttu-id="80ff4-130">Связанные команды</span><span class="sxs-lookup"><span data-stu-id="80ff4-130">Related commands</span></span>                                                                              |
| ------------------------------------------------------------------------------------------ | --------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <span data-ttu-id="80ff4-131">Предоставление прав администратора подключающемуся пользователю для обхода JEA</span><span class="sxs-lookup"><span data-stu-id="80ff4-131">Granting the connecting user admin privileges to bypass JEA</span></span>                                | `Add-LocalGroupMember -Member 'CONTOSO\jdoe' -Group 'Administrators'` | <span data-ttu-id="80ff4-132">`Add-ADGroupMember`, `Add-LocalGroupMember`, `net.exe`, `dsadd.exe`</span><span class="sxs-lookup"><span data-stu-id="80ff4-132">`Add-ADGroupMember`, `Add-LocalGroupMember`, `net.exe`, `dsadd.exe`</span></span>                                                                                                        |
| <span data-ttu-id="80ff4-133">Выполнение произвольного кода, например вредоносных программ, эксплойтов или пользовательских сценариев для обхода защиты</span><span class="sxs-lookup"><span data-stu-id="80ff4-133">Running arbitrary code, such as malware, exploits, or custom scripts to bypass protections</span></span> | `Start-Process -FilePath '\\san\share\malware.exe'`                   | <span data-ttu-id="80ff4-134">`Start-Process`, `New-Service`, `Invoke-Item`, `Invoke-WmiMethod`, `Invoke-CimMethod`, `Invoke-Expression`, `Invoke-Command`, `New-ScheduledTask`, `Register-ScheduledJob`</span><span class="sxs-lookup"><span data-stu-id="80ff4-134">`Start-Process`, `New-Service`, `Invoke-Item`, `Invoke-WmiMethod`, `Invoke-CimMethod`, `Invoke-Expression`, `Invoke-Command`, `New-ScheduledTask`, `Register-ScheduledJob`</span></span> |

## <a name="create-a-role-capability-file"></a><span data-ttu-id="80ff4-135">Создание файла возможностей ролей</span><span class="sxs-lookup"><span data-stu-id="80ff4-135">Create a role capability file</span></span>

<span data-ttu-id="80ff4-136">Вы можете создать новый файл возможности роли с помощью командлета [New-PSRoleCapabilityFile](/powershell/module/microsoft.powershell.core/new-psrolecapabilityfile).</span><span class="sxs-lookup"><span data-stu-id="80ff4-136">You can create a new PowerShell role capability file with the [New-PSRoleCapabilityFile](/powershell/module/microsoft.powershell.core/new-psrolecapabilityfile) cmdlet.</span></span>

```powershell
New-PSRoleCapabilityFile -Path .\MyFirstJEARole.psrc
```

<span data-ttu-id="80ff4-137">Полученный файл возможностей роли должен быть изменен, чтобы разрешить команды, необходимые для роли.</span><span class="sxs-lookup"><span data-stu-id="80ff4-137">The resulting role capability file should be edited to allow the commands required for the role.</span></span> <span data-ttu-id="80ff4-138">Справочная документация PowerShell содержит несколько примеров того, как можно настроить такой файл.</span><span class="sxs-lookup"><span data-stu-id="80ff4-138">The PowerShell help documentation contains several examples of how you can configure the file.</span></span>

### <a name="allowing-powershell-cmdlets-and-functions"></a><span data-ttu-id="80ff4-139">Разрешение функций и командлетов PowerShell</span><span class="sxs-lookup"><span data-stu-id="80ff4-139">Allowing PowerShell cmdlets and functions</span></span>

<span data-ttu-id="80ff4-140">Чтобы разрешить пользователям запускать функции или командлеты PowerShell, добавьте имя функции или командлета в поле VisibleFunctions или VisibleCmdlets.</span><span class="sxs-lookup"><span data-stu-id="80ff4-140">To authorize users to run PowerShell cmdlets or functions, add the cmdlet or function name to the VisibleCmdlets or VisibleFunctions fields.</span></span> <span data-ttu-id="80ff4-141">Если вы не уверены, является ли команда командлетом или функцией, выполните `Get-Command <name>` и проверьте свойство **CommandType** в выходных данных.</span><span class="sxs-lookup"><span data-stu-id="80ff4-141">If you aren't sure whether a command is a cmdlet or function, you can run `Get-Command <name>` and check the **CommandType** property in the output.</span></span>

```powershell
VisibleCmdlets = 'Restart-Computer', 'Get-NetIPAddress'
```

<span data-ttu-id="80ff4-142">Иногда область действия командлета или функции слишком широка для потребностей пользователей.</span><span class="sxs-lookup"><span data-stu-id="80ff4-142">Sometimes the scope of a specific cmdlet or function is too broad for your users' needs.</span></span> <span data-ttu-id="80ff4-143">Например, администратору DNS, скорее всего, потребуется только доступ для перезапуска службы DNS.</span><span class="sxs-lookup"><span data-stu-id="80ff4-143">A DNS admin, for example, probably only needs access to restart the DNS service.</span></span> <span data-ttu-id="80ff4-144">В средах с несколькими клиентами клиенты имеют доступ к средствам самостоятельного управления.</span><span class="sxs-lookup"><span data-stu-id="80ff4-144">In multi-tenant environments, tenants have access to self-service management tools.</span></span> <span data-ttu-id="80ff4-145">Клиенты должны быть ограничены, чтобы они могли управлять только собственными ресурсами.</span><span class="sxs-lookup"><span data-stu-id="80ff4-145">Tenants should be limited to managing their own resources.</span></span> <span data-ttu-id="80ff4-146">В этих случаях можно ограничить доступные параметры из командлета или функции.</span><span class="sxs-lookup"><span data-stu-id="80ff4-146">For these cases, you can restrict which parameters are exposed from the cmdlet or function.</span></span>

```powershell
VisibleCmdlets = @{ Name = 'Restart-Computer'; Parameters = @{ Name = 'Name' }}
```

<span data-ttu-id="80ff4-147">В более сложных сценариях может потребоваться ограничить значения, которые можно задать для этих параметров.</span><span class="sxs-lookup"><span data-stu-id="80ff4-147">In more advanced scenarios, you may also need to restrict the values a user may use with these parameters.</span></span> <span data-ttu-id="80ff4-148">Возможности ролей позволяют задать набор допустимых значений или шаблон регулярного выражения, который определяет, какие входные данные допустимы.</span><span class="sxs-lookup"><span data-stu-id="80ff4-148">Role capabilities let you define a set of values or a regular expression pattern that determine what input is allowed.</span></span>

```powershell
VisibleCmdlets = @{ Name = 'Restart-Service'; Parameters = @{ Name = 'Name'; ValidateSet = 'Dns', 'Spooler' }},
                 @{ Name = 'Start-Website'; Parameters = @{ Name = 'Name'; ValidatePattern = 'HR_*' }}
```

> [!NOTE]
> <span data-ttu-id="80ff4-149">[Общие параметры PowerShell](/powershell/module/microsoft.powershell.core/about/about_commonparameters) всегда разрешены, даже если ограничить доступные параметры.</span><span class="sxs-lookup"><span data-stu-id="80ff4-149">The [common PowerShell parameters](/powershell/module/microsoft.powershell.core/about/about_commonparameters) are always allowed, even if you restrict the available parameters.</span></span>
> <span data-ttu-id="80ff4-150">Их не следует явно указывать в поле "Parameters".</span><span class="sxs-lookup"><span data-stu-id="80ff4-150">You should not explicitly list them in the Parameters field.</span></span>

<span data-ttu-id="80ff4-151">В следующей таблице описаны различные способы настройки видимого командлета или видимой функции.</span><span class="sxs-lookup"><span data-stu-id="80ff4-151">The table below describes the various ways you can customize a visible cmdlet or function.</span></span>
<span data-ttu-id="80ff4-152">Вы можете комбинировать любые приведенные ниже примеры в поле **VisibleCmdlets**.</span><span class="sxs-lookup"><span data-stu-id="80ff4-152">You can mix and match any of the below in the **VisibleCmdlets** field.</span></span>

|                                           <span data-ttu-id="80ff4-153">Пример</span><span class="sxs-lookup"><span data-stu-id="80ff4-153">Example</span></span>                                           |                                                             <span data-ttu-id="80ff4-154">Вариант использования</span><span class="sxs-lookup"><span data-stu-id="80ff4-154">Use case</span></span>                                                              |
| ------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| <span data-ttu-id="80ff4-155">`'My-Func'` или `@{ Name = 'My-Func' }`</span><span class="sxs-lookup"><span data-stu-id="80ff4-155">`'My-Func'` or `@{ Name = 'My-Func' }`</span></span>                                                      | <span data-ttu-id="80ff4-156">Разрешает пользователю выполнить `My-Func` без каких-либо ограничений для параметров.</span><span class="sxs-lookup"><span data-stu-id="80ff4-156">Allows the user to run `My-Func` without any restrictions on the parameters.</span></span>                                                      |
| `'MyModule\My-Func'`                                                                        | <span data-ttu-id="80ff4-157">Разрешает пользователю выполнить `My-Func` из модуля `MyModule` без каких-либо ограничений для параметров.</span><span class="sxs-lookup"><span data-stu-id="80ff4-157">Allows the user to run `My-Func` from the module `MyModule` without any restrictions on the parameters.</span></span>                           |
| `'My-*'`                                                                                    | <span data-ttu-id="80ff4-158">Разрешает пользователю выполнить любой командлет или функцию с командой `My`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-158">Allows the user to run any cmdlet or function with the verb `My`.</span></span>                                                                 |
| `'*-Func'`                                                                                  | <span data-ttu-id="80ff4-159">Разрешает пользователю выполнить любой командлет или функцию с существительным `Func`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-159">Allows the user to run any cmdlet or function with the noun `Func`.</span></span>                                                               |
| `@{ Name = 'My-Func'; Parameters = @{ Name = 'Param1'}, @{ Name = 'Param2' }}`              | <span data-ttu-id="80ff4-160">Разрешает пользователю выполнить `My-Func` с параметрами `Param1` и `Param2`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-160">Allows the user to run `My-Func` with the `Param1` and `Param2` parameters.</span></span> <span data-ttu-id="80ff4-161">Для параметров можно задать любое значение.</span><span class="sxs-lookup"><span data-stu-id="80ff4-161">Any value can be supplied to the parameters.</span></span>          |
| `@{ Name = 'My-Func'; Parameters = @{ Name = 'Param1'; ValidateSet = 'Value1', 'Value2' }}` | <span data-ttu-id="80ff4-162">Разрешает пользователю выполнить `My-Func` с параметром `Param1`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-162">Allows the user to run `My-Func` with the `Param1` parameter.</span></span> <span data-ttu-id="80ff4-163">Для параметра можно задать только значение "Value1" или "Value2".</span><span class="sxs-lookup"><span data-stu-id="80ff4-163">Only "Value1" and "Value2" can be supplied to the parameter.</span></span>        |
| `@{ Name = 'My-Func'; Parameters = @{ Name = 'Param1'; ValidatePattern = 'contoso.*' }}`    | <span data-ttu-id="80ff4-164">Разрешает пользователю выполнить `My-Func` с параметром `Param1`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-164">Allows the user to run `My-Func` with the `Param1` parameter.</span></span> <span data-ttu-id="80ff4-165">Для параметра можно задать любое значение, начинающееся с "contoso".</span><span class="sxs-lookup"><span data-stu-id="80ff4-165">Any value starting with "contoso" can be supplied to the parameter.</span></span> |

> [!WARNING]
> <span data-ttu-id="80ff4-166">Для обеспечения наилучшей безопасности при определении видимых командлетов или функций рекомендуется не использовать подстановочные знаки.</span><span class="sxs-lookup"><span data-stu-id="80ff4-166">For best security practices, it is not recommended to use wildcards when defining visible cmdlets or functions.</span></span> <span data-ttu-id="80ff4-167">Вместо этого следует явно указать каждую надежную команду, чтобы убедиться, что не будут случайно разрешены никакие другие команды, которые используют такую же схему именования.</span><span class="sxs-lookup"><span data-stu-id="80ff4-167">Instead, you should explicitly list each trusted command to ensure no other commands that share the same naming scheme are unintentionally authorized.</span></span>

<span data-ttu-id="80ff4-168">Вы не можете применить **ValidatePattern** вместе с **ValidateSet** для одного командлета или одной функции.</span><span class="sxs-lookup"><span data-stu-id="80ff4-168">You can't apply both a **ValidatePattern** and **ValidateSet** to the same cmdlet or function.</span></span>

<span data-ttu-id="80ff4-169">В противном случае **ValidatePattern** переопределит **ValidateSet**.</span><span class="sxs-lookup"><span data-stu-id="80ff4-169">If you do, the **ValidatePattern** overrides the **ValidateSet**.</span></span>

<span data-ttu-id="80ff4-170">Дополнительные сведения о **ValidatePattern** см. в [этой записи блога *Hey, Scripting Guy!*](https://devblogs.microsoft.com/scripting/validate-powershell-parameters-before-running-the-script/) и справочных материалах о [регулярных выражениях PowerShell](/powershell/module/microsoft.powershell.core/about/about_regular_expressions).</span><span class="sxs-lookup"><span data-stu-id="80ff4-170">For more information about **ValidatePattern**, check out [this *Hey, Scripting Guy!* post](https://devblogs.microsoft.com/scripting/validate-powershell-parameters-before-running-the-script/) and the [PowerShell Regular Expressions](/powershell/module/microsoft.powershell.core/about/about_regular_expressions) reference content.</span></span>

### <a name="allowing-external-commands-and-powershell-scripts"></a><span data-ttu-id="80ff4-171">Разрешение внешних команд и сценариев PowerShell</span><span class="sxs-lookup"><span data-stu-id="80ff4-171">Allowing external commands and PowerShell scripts</span></span>

<span data-ttu-id="80ff4-172">Чтобы разрешить пользователям запускать исполняемые файлы и сценарии PowerShell (PS1) в сеансе JEA, нужно добавить полный путь к каждой программы в поле **VisibleExternalCommands**.</span><span class="sxs-lookup"><span data-stu-id="80ff4-172">To allow users to run executables and PowerShell scripts (.ps1) in a JEA session, you have to add the full path to each program in the **VisibleExternalCommands** field.</span></span>

```powershell
VisibleExternalCommands = 'C:\Windows\System32\whoami.exe', 'C:\Program Files\Contoso\Scripts\UpdateITSoftware.ps1'
```

<span data-ttu-id="80ff4-173">По возможности следует использовать командлеты или функции PowerShell, эквивалентные любым внешним исполняемым файлам, которые вы разрешаете, так как для этих функций и командлетов PowerShell вы можете управлять разрешенными параметрами.</span><span class="sxs-lookup"><span data-stu-id="80ff4-173">Where possible, to use PowerShell cmdlet or function equivalents for any external executables you authorize since you have control over the parameters allowed with PowerShell cmdlets and functions.</span></span>

<span data-ttu-id="80ff4-174">Многие исполняемые файлы дают возможность считать текущее состояние и затем изменить его, указав различные параметры.</span><span class="sxs-lookup"><span data-stu-id="80ff4-174">Many executables allow you to read the current state and then change it by providing different parameters.</span></span>

<span data-ttu-id="80ff4-175">Например, рассмотрим роль администратора файлового сервера, который управляет набором общих сетевых ресурсов, размещенных в системе.</span><span class="sxs-lookup"><span data-stu-id="80ff4-175">For example, consider the role of a file server admin that manages network shares hosted on a system.</span></span> <span data-ttu-id="80ff4-176">Одним из способов управления ими является использование `net share`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-176">One way of managing shares is to use `net share`.</span></span> <span data-ttu-id="80ff4-177">Однако разрешение использования **net.exe** очень опасно, так как администратор может легко воспользоваться этой командой для получения прав администратора с помощью `net group Administrators unprivilegedjeauser /add`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-177">However, allowing **net.exe** is dangerous because the user could use the command to gain admin privileges with `net group Administrators unprivilegedjeauser /add`.</span></span> <span data-ttu-id="80ff4-178">Безопаснее разрешить командлет [Get-SmbShare](/powershell/module/smbshare/get-smbshare), которой дает тот же результат, но имеет гораздо более ограниченную область действия.</span><span class="sxs-lookup"><span data-stu-id="80ff4-178">A more secure option is to allow [Get-SmbShare](/powershell/module/smbshare/get-smbshare), which achieves the same result but has a much more limited scope.</span></span>

<span data-ttu-id="80ff4-179">Делая внешние команды доступными для пользователей в рамках сеанса JEA, всегда указывайте полный путь к исполняемому файлу.</span><span class="sxs-lookup"><span data-stu-id="80ff4-179">When making external commands available to users in a JEA session, always specify the complete path to the executable.</span></span> <span data-ttu-id="80ff4-180">Это предотвращает выполнение одноименных потенциально вредоносных программ, расположенных в других местах в системе.</span><span class="sxs-lookup"><span data-stu-id="80ff4-180">This prevents the execution of similarly named and potentially malicious programs located elsewhere on the system.</span></span>

### <a name="allowing-access-to-powershell-providers"></a><span data-ttu-id="80ff4-181">Разрешение доступа к поставщикам PowerShell</span><span class="sxs-lookup"><span data-stu-id="80ff4-181">Allowing access to PowerShell providers</span></span>

<span data-ttu-id="80ff4-182">По умолчанию в сеансах JEA нет доступных поставщиков PowerShell.</span><span class="sxs-lookup"><span data-stu-id="80ff4-182">By default, no PowerShell providers are available in JEA sessions.</span></span> <span data-ttu-id="80ff4-183">Это служит для снижения риска раскрытия конфиденциальной информации и параметров конфигурации подключающемуся пользователю.</span><span class="sxs-lookup"><span data-stu-id="80ff4-183">This reduces the risk of sensitive information and configuration settings being disclosed to the connecting user.</span></span>

<span data-ttu-id="80ff4-184">При необходимости доступ к поставщикам PowerShell можно разрешить с помощью команды `VisibleProviders`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-184">When necessary, you can allow access to the PowerShell providers using the `VisibleProviders` command.</span></span> <span data-ttu-id="80ff4-185">Для просмотра полного списка поставщиков запустите `Get-PSProvider`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-185">For a full list of providers, run `Get-PSProvider`.</span></span>

```powershell
VisibleProviders = 'Registry'
```

<span data-ttu-id="80ff4-186">Для простых задач, которым требуется доступ к файловой системе, реестру, хранилищу сертификатов, или других конфиденциальных поставщиков можно написать настраиваемую функцию, которая работает с поставщиком от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="80ff4-186">For simple tasks that require access to the file system, registry, certificate store, or other sensitive providers, consider writing a custom function that works with the provider on the user's behalf.</span></span> <span data-ttu-id="80ff4-187">К функциям, командлетам и внешним программам, доступным в сеансе JEA, не применяются те же ограничения, что и для JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-187">The functions, cmdlets, and external programs available in a JEA session aren't subject to the same constraints as JEA.</span></span> <span data-ttu-id="80ff4-188">Они могут по умолчанию получить доступ к любому поставщику.</span><span class="sxs-lookup"><span data-stu-id="80ff4-188">They can access any provider by default.</span></span> <span data-ttu-id="80ff4-189">В случаях, когда требуется скопировать файлы из конечной точки JEA или на нее, рассмотрите возможность использования [диска пользователя](session-configurations.md#user-drive).</span><span class="sxs-lookup"><span data-stu-id="80ff4-189">Also consider using the [user drive](session-configurations.md#user-drive) when copying files to or from a JEA endpoint is required.</span></span>

### <a name="creating-custom-functions"></a><span data-ttu-id="80ff4-190">Создание настраиваемых функций</span><span class="sxs-lookup"><span data-stu-id="80ff4-190">Creating custom functions</span></span>

<span data-ttu-id="80ff4-191">В файле возможностей роли можно создать настраиваемые функции, чтобы упростить выполнение сложных задач для конечных пользователей.</span><span class="sxs-lookup"><span data-stu-id="80ff4-191">You can author custom functions in a role capability file to simplify complex tasks for your end users.</span></span> <span data-ttu-id="80ff4-192">Настраиваемые функции также удобны, когда требуется расширенная логика проверки для значений параметров командлета.</span><span class="sxs-lookup"><span data-stu-id="80ff4-192">Custom functions are also useful when you require advanced validation logic for cmdlet parameter values.</span></span> <span data-ttu-id="80ff4-193">Вы можете составлять простые функции в поле **FunctionDefinitions**:</span><span class="sxs-lookup"><span data-stu-id="80ff4-193">You can write simple functions in the **FunctionDefinitions** field:</span></span>

```powershell
VisibleFunctions = 'Get-TopProcess'

FunctionDefinitions = @{
    Name = 'Get-TopProcess'

    ScriptBlock = {
        param($Count = 10)

        Get-Process | Sort-Object -Property CPU -Descending |
            Microsoft.PowerShell.Utility\Select-Object -First $Count
    }
}
```

> [!IMPORTANT]
> <span data-ttu-id="80ff4-194">Не забудьте добавить имя настраиваемых функций в поле **VisibleFunctions**, чтобы пользователи JEA могли запускать их.</span><span class="sxs-lookup"><span data-stu-id="80ff4-194">Don't forget to add the name of your custom functions to the **VisibleFunctions** field so they can be run by the JEA users.</span></span>

<span data-ttu-id="80ff4-195">Основная часть (блок сценария) настраиваемых функций запускается в языковом режиме по умолчанию для данной системы, и на нее не налагаются ограничения языка JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-195">The body (script block) of custom functions runs in the default language mode for the system and isn't subject to JEA's language constraints.</span></span> <span data-ttu-id="80ff4-196">Это означает, что функции имеют доступ к файловой системе и реестру и могут запускать команды, которые не были сделаны видимыми в файле возможностей роли.</span><span class="sxs-lookup"><span data-stu-id="80ff4-196">This means that functions can access the file system and registry, and run commands that weren't made visible in the role capability file.</span></span> <span data-ttu-id="80ff4-197">Будьте внимательны, чтобы избежать выполнения произвольного кода при использовании параметров.</span><span class="sxs-lookup"><span data-stu-id="80ff4-197">Take care to avoid running arbitrary code when using parameters.</span></span> <span data-ttu-id="80ff4-198">Не передавайте вводимые пользователем данные напрямую в такие командлеты, как `Invoke-Expression`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-198">Avoid piping user input directly into cmdlets like `Invoke-Expression`.</span></span>

<span data-ttu-id="80ff4-199">В приведенном выше примере можно заметить, что полное имя модуля (FQMN) `Microsoft.PowerShell.Utility\Select-Object` было использовано вместо сокращенного `Select-Object`.</span><span class="sxs-lookup"><span data-stu-id="80ff4-199">In the above example, notice that the fully qualified module name (FQMN) `Microsoft.PowerShell.Utility\Select-Object` was used instead of the shorthand `Select-Object`.</span></span>
<span data-ttu-id="80ff4-200">Функции, определенные в файлах возможностей роли, по-прежнему подчиняются области действия сеансов JEA, что включает в себя функции прокси-сервера, создаваемые JEA для ограничения существующих команд.</span><span class="sxs-lookup"><span data-stu-id="80ff4-200">Functions defined in role capability files are still subject to the scope of JEA sessions, which includes the proxy functions JEA creates to constrain existing commands.</span></span>

<span data-ttu-id="80ff4-201">По умолчанию `Select-Object` является во всех сеансах JEA ограниченным командлетом, который не позволяет выбрать произвольные свойства для объектов.</span><span class="sxs-lookup"><span data-stu-id="80ff4-201">By default, `Select-Object` is a constrained cmdlet in all JEA sessions that doesn't allow the selection of arbitrary properties on objects.</span></span> <span data-ttu-id="80ff4-202">Чтобы использовать `Select-Object` в функциях без ограничений, требуется явно запросить полную реализацию, указав полное имя модуля.</span><span class="sxs-lookup"><span data-stu-id="80ff4-202">To use the unconstrained `Select-Object` in functions, you must explicitly request the full implementation using the FQMN.</span></span> <span data-ttu-id="80ff4-203">Любой ограниченный командлет в сеансе JEA имеет те же ограничения при вызове из функции.</span><span class="sxs-lookup"><span data-stu-id="80ff4-203">Any constrained cmdlet in a JEA session has the same constraints when invoked from a function.</span></span> <span data-ttu-id="80ff4-204">Дополнительные сведения см. в разделе [about_Command_Precedence](/powershell/module/microsoft.powershell.core/about/about_command_precedence).</span><span class="sxs-lookup"><span data-stu-id="80ff4-204">For more information, see [about_Command_Precedence](/powershell/module/microsoft.powershell.core/about/about_command_precedence).</span></span>

<span data-ttu-id="80ff4-205">При наличии нескольких настраиваемых функций может быть проще поместить их в модуль сценария PowerShell.</span><span class="sxs-lookup"><span data-stu-id="80ff4-205">If you're writing several custom functions, it's more convenient to put them in a PowerShell script module.</span></span> <span data-ttu-id="80ff4-206">Затем можно сделать эти функции видимыми в сеансе JEA с помощью поля **VisibleFunctions**, как и в случае со встроенными и сторонними модулями.</span><span class="sxs-lookup"><span data-stu-id="80ff4-206">You make those functions visible in the JEA session using the **VisibleFunctions** field like you would with built-in and third-party modules.</span></span>

<span data-ttu-id="80ff4-207">Для корректной работы завершения при нажатии клавиши TAB в сеансах JEA необходимо включить встроенную функцию `tabexpansion2` в список **VisibleFunctions**.</span><span class="sxs-lookup"><span data-stu-id="80ff4-207">For tab completion to work properly in JEA sessions you must include the built-in function `tabexpansion2` in the **VisibleFunctions** list.</span></span>

## <a name="make-the-role-capabilities-available-to-a-configuration"></a><span data-ttu-id="80ff4-208">Обеспечение доступности возможностей роли для конфигурации</span><span class="sxs-lookup"><span data-stu-id="80ff4-208">Make the role capabilities available to a configuration</span></span>

<span data-ttu-id="80ff4-209">До PowerShell 6, чтобы среда PowerShell обнаружила файл возможности роли, его нужно было поместить в папку **RoleCapabilities** в модуле PowerShell.</span><span class="sxs-lookup"><span data-stu-id="80ff4-209">Prior to PowerShell 6, for PowerShell to find a role capability file it must be stored in a **RoleCapabilities** folder in a PowerShell module.</span></span> <span data-ttu-id="80ff4-210">Этот модуль может храниться в любой папке, включенной в переменную среды `$env:PSModulePath`, однако не следует помещать его в папку `$env:SystemRoot\System32` либо в папку, где они могут быть изменены пользователями, которые не являются доверенными.</span><span class="sxs-lookup"><span data-stu-id="80ff4-210">The module can be stored in any folder included in the `$env:PSModulePath` environment variable, however you shouldn't place it in `$env:SystemRoot\System32` or a folder where untrusted users could modify the files.</span></span>

<span data-ttu-id="80ff4-211">В следующем примере для размещения файла возможностей роли в пути `$env:ProgramFiles` создается модуль скрипта PowerShell с именем **ContosoJEA**.</span><span class="sxs-lookup"><span data-stu-id="80ff4-211">The following example creates a PowerShell script module called **ContosoJEA** in the `$env:ProgramFiles` path to host the role capabilities file.</span></span>

```powershell
# Create a folder for the module
$modulePath = Join-Path $env:ProgramFiles "WindowsPowerShell\Modules\ContosoJEA"
New-Item -ItemType Directory -Path $modulePath

# Create an empty script module and module manifest.
# At least one file in the module folder must have the same name as the folder itself.
New-Item -ItemType File -Path (Join-Path $modulePath "ContosoJEAFunctions.psm1")
New-ModuleManifest -Path (Join-Path $modulePath "ContosoJEA.psd1") -RootModule "ContosoJEAFunctions.psm1"

# Create the RoleCapabilities folder and copy in the PSRC file
$rcFolder = Join-Path $modulePath "RoleCapabilities"
New-Item -ItemType Directory $rcFolder
Copy-Item -Path .\MyFirstJEARole.psrc -Destination $rcFolder
```

<span data-ttu-id="80ff4-212">Дополнительные сведения о модулях PowerShell см. в разделе [Основные сведения о модуле PowerShell](/powershell/scripting/developer/windows-powershell).</span><span class="sxs-lookup"><span data-stu-id="80ff4-212">For more information about PowerShell modules, see [Understanding a PowerShell Module](/powershell/scripting/developer/windows-powershell).</span></span>

<span data-ttu-id="80ff4-213">Начиная с PowerShell 6, свойство **RoleDefinitions** было добавлено в файл конфигурации сеанса.</span><span class="sxs-lookup"><span data-stu-id="80ff4-213">Starting in PowerShell 6, the **RoleDefinitions** property was added to the session configuration file.</span></span> <span data-ttu-id="80ff4-214">Это свойство позволяет указать расположение файла конфигурации роли для определения роли.</span><span class="sxs-lookup"><span data-stu-id="80ff4-214">This property lets you specify the location of a role configuration file for your role definition.</span></span> <span data-ttu-id="80ff4-215">См. примеры в [New-PSSessionConfigurationFile](/powershell/module/microsoft.powershell.core/new-pssessionconfigurationfile).</span><span class="sxs-lookup"><span data-stu-id="80ff4-215">See the examples in [New-PSSessionConfigurationFile](/powershell/module/microsoft.powershell.core/new-pssessionconfigurationfile).</span></span>

## <a name="updating-role-capabilities"></a><span data-ttu-id="80ff4-216">Изменение возможностей ролей</span><span class="sxs-lookup"><span data-stu-id="80ff4-216">Updating role capabilities</span></span>

<span data-ttu-id="80ff4-217">Изменить файл возможностей роли, чтобы обновить параметры, можно в любое время.</span><span class="sxs-lookup"><span data-stu-id="80ff4-217">You can edit a role capability file to update the settings at any time.</span></span> <span data-ttu-id="80ff4-218">Все новые сеансы JEA, запущенные после изменения возможности роли, будут использовать обновленные возможности.</span><span class="sxs-lookup"><span data-stu-id="80ff4-218">Any new JEA sessions started after the role capability has been updated will reflect the revised capabilities.</span></span>

<span data-ttu-id="80ff4-219">Именно поэтому так важно управлять доступом к папке возможностей роли.</span><span class="sxs-lookup"><span data-stu-id="80ff4-219">This is why controlling access to the role capabilities folder is so important.</span></span> <span data-ttu-id="80ff4-220">Изменять файлы возможностей ролей должно быть разрешено только наиболее надежным администраторам.</span><span class="sxs-lookup"><span data-stu-id="80ff4-220">Only highly trusted administrators should be allowed to change role capability files.</span></span> <span data-ttu-id="80ff4-221">Если пользователь, не являющийся доверенным, может изменять файлы возможностей ролей, он легко сможет получить доступ к командлетам, повышающим его права.</span><span class="sxs-lookup"><span data-stu-id="80ff4-221">If an untrusted user can change role capability files, they can easily give themselves access to cmdlets that allow them to elevate their privileges.</span></span>

<span data-ttu-id="80ff4-222">Администраторам, желающим заблокировать доступ к возможностям ролей, следует убедиться, что учетная запись Local System имеет доступ на чтение к файлам возможностей ролей и содержащим их модулям.</span><span class="sxs-lookup"><span data-stu-id="80ff4-222">For administrators looking to lock down access to the role capabilities, ensure Local System has read access to the role capability files and containing modules.</span></span>

## <a name="how-role-capabilities-are-merged"></a><span data-ttu-id="80ff4-223">Способ слияния возможностей ролей</span><span class="sxs-lookup"><span data-stu-id="80ff4-223">How role capabilities are merged</span></span>

<span data-ttu-id="80ff4-224">Пользователи получают доступ ко всем соответствующим возможностям ролей в [файле конфигурации сеанса](session-configurations.md) при входе в сеанс JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-224">Users are granted access to all matching role capabilities in the [session configuration file](session-configurations.md) when they enter a JEA session.</span></span> <span data-ttu-id="80ff4-225">JEA пытается предоставить такому пользователю наиболее широкий набор команд, разрешенных для любой из этих ролей.</span><span class="sxs-lookup"><span data-stu-id="80ff4-225">JEA tries to give the user the most permissive set of commands allowed by any of the roles.</span></span>

### <a name="visiblecmdlets-and-visiblefunctions"></a><span data-ttu-id="80ff4-226">VisibleCmdlets и VisibleFunctions</span><span class="sxs-lookup"><span data-stu-id="80ff4-226">VisibleCmdlets and VisibleFunctions</span></span>

<span data-ttu-id="80ff4-227">Наиболее сложная логика слияния затрагивает командлеты и функции, параметры и значения параметров которых могут быть ограничены в JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-227">The most complex merge logic affects cmdlets and functions, which can have their parameters and parameter values limited in JEA.</span></span>

<span data-ttu-id="80ff4-228">Действуют следующие правила:</span><span class="sxs-lookup"><span data-stu-id="80ff4-228">The rules are as follows:</span></span>

1. <span data-ttu-id="80ff4-229">Если командлет является видимым всего в одной роли, он видим для пользователя с любыми применимыми ограничениями параметров.</span><span class="sxs-lookup"><span data-stu-id="80ff4-229">If a cmdlet is only made visible in one role, it is visible to the user with any applicable parameter constraints.</span></span>
2. <span data-ttu-id="80ff4-230">Если командлет является видимым в нескольких ролях, каждая из которых налагает на него схожие ограничения, он видим пользователю с такими ограничениями.</span><span class="sxs-lookup"><span data-stu-id="80ff4-230">If a cmdlet is made visible in more than one role, and each role has the same constraints on the cmdlet, the cmdlet is visible to the user with those constraints.</span></span>
3. <span data-ttu-id="80ff4-231">Если командлет является видимым в нескольких ролях, каждая из которых разрешает иной набор параметров, пользователю видим как командлет, так и все параметры, определенные для каждой роли.</span><span class="sxs-lookup"><span data-stu-id="80ff4-231">If a cmdlet is made visible in more than one role, and each role allows a different set of parameters, the cmdlet and all the parameters defined across every role are visible to the user.</span></span>
   <span data-ttu-id="80ff4-232">Если одна из ролей не имеет ограничений для параметров, будет разрешены все параметры.</span><span class="sxs-lookup"><span data-stu-id="80ff4-232">If one role doesn't have constraints on the parameters, all parameters are allowed.</span></span>
4. <span data-ttu-id="80ff4-233">Если одна из ролей определяет набор или шаблон проверок для параметра командлета, а другая разрешает параметр, но не ограничивает его значения, набор или шаблон проверок будет игнорироваться.</span><span class="sxs-lookup"><span data-stu-id="80ff4-233">If one role defines a validate set or validate pattern for a cmdlet parameter, and the other role allows the parameter but does not constrain the parameter values, the validate set or pattern is ignored.</span></span>
5. <span data-ttu-id="80ff4-234">Если набор проверок определен для одного параметра командлета в нескольких ролях, все значения из всех наборов проверок будут разрешены.</span><span class="sxs-lookup"><span data-stu-id="80ff4-234">If a validate set is defined for the same cmdlet parameter in more than one role, all values from all validate sets are allowed.</span></span>
6. <span data-ttu-id="80ff4-235">Если шаблон проверок определен для одного параметра командлета в нескольких ролях, будут разрешены все значения, соответствующие любому из шаблонов.</span><span class="sxs-lookup"><span data-stu-id="80ff4-235">If a validate pattern is defined for the same cmdlet parameter in more than one role, any values that match any of the patterns are allowed.</span></span>
7. <span data-ttu-id="80ff4-236">Если набор проверок определен в одной или нескольких ролях и шаблон проверок определен в другой роли для того же параметра командлета, набор проверок игнорируется, а к оставшимся шаблонам проверок применяется правило (6).</span><span class="sxs-lookup"><span data-stu-id="80ff4-236">If a validate set is defined in one or more roles, and a validate pattern is defined in another role for the same cmdlet parameter, the validate set is ignored and rule (6) applies to the remaining validate patterns.</span></span>

<span data-ttu-id="80ff4-237">Ниже приведен пример объединения ролей согласно этим правилам:</span><span class="sxs-lookup"><span data-stu-id="80ff4-237">Below is an example of how roles are merged according to these rules:</span></span>

```powershell
# Role A Visible Cmdlets
$roleA = @{
    VisibleCmdlets = 'Get-Service',
                     @{ Name = 'Restart-Service';
                        Parameters = @{ Name = 'DisplayName'; ValidateSet = 'DNS Client' } }
}

# Role B Visible Cmdlets
$roleB = @{
    VisibleCmdlets = @{ Name = 'Get-Service';
                        Parameters = @{ Name = 'DisplayName'; ValidatePattern = 'DNS.*' } },
                     @{ Name = 'Restart-Service';
                        Parameters = @{ Name = 'DisplayName'; ValidateSet = 'DNS Server' } }
}

# Resulting permissions for a user who belongs to both role A and B
# - The constraint in role B for the DisplayName parameter on Get-Service
#   is ignored because of rule #4
# - The ValidateSets for Restart-Service are merged because both roles use
#   ValidateSet on the same parameter per rule #5
$mergedAandB = @{
    VisibleCmdlets = 'Get-Service',
                     @{ Name = 'Restart-Service';
                        Parameters = @{ Name = 'DisplayName'; ValidateSet = 'DNS Client', 'DNS Server' } }
}
```

### <a name="visibleexternalcommands-visiblealiases-visibleproviders-scriptstoprocess"></a><span data-ttu-id="80ff4-238">VisibleExternalCommands, VisibleAliases, VisibleProviders, ScriptsToProcess</span><span class="sxs-lookup"><span data-stu-id="80ff4-238">VisibleExternalCommands, VisibleAliases, VisibleProviders, ScriptsToProcess</span></span>

<span data-ttu-id="80ff4-239">Все другие поля в файле роли возможностей ролей добавляются в совокупный набор допустимых внешних команд, псевдонимов, поставщиков и сценариев запуска.</span><span class="sxs-lookup"><span data-stu-id="80ff4-239">All other fields in the role capability file are added to a cumulative set of allowable external commands, aliases, providers, and startup scripts.</span></span> <span data-ttu-id="80ff4-240">Команда, псевдоним, поставщик или сценарий, доступные в одной возможности роли, доступны пользователю JEA.</span><span class="sxs-lookup"><span data-stu-id="80ff4-240">Any command, alias, provider, or script available in one role capability is available to the JEA user.</span></span>

<span data-ttu-id="80ff4-241">Внимательно следите за тем, чтобы комбинированный набор поставщиков из одной возможности роли и командлеты, функции и команды из другой не разрешали пользователям непреднамеренный доступ к системным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="80ff4-241">Be careful to ensure that the combined set of providers from one role capability and cmdlets/functions/commands from another don't allow users unintentional access to system resources.</span></span>
<span data-ttu-id="80ff4-242">Например, если одна роль разрешает командлет `Remove-Item`, а другая разрешает поставщик `FileSystem`, существует риск того, что пользователь JEA удалит произвольные файлы на компьютере.</span><span class="sxs-lookup"><span data-stu-id="80ff4-242">For example, if one role allows the `Remove-Item` cmdlet and another allows the `FileSystem` provider, you are at risk of a JEA user deleting arbitrary files on your computer.</span></span> <span data-ttu-id="80ff4-243">Дополнительные сведения об определении действующих разрешений пользователей см. в [разделе об аудите JEA](audit-and-report.md).</span><span class="sxs-lookup"><span data-stu-id="80ff4-243">Additional information about identifying users' effective permissions can be found in the [auditing JEA](audit-and-report.md) article.</span></span>

## <a name="next-steps"></a><span data-ttu-id="80ff4-244">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="80ff4-244">Next steps</span></span>

[<span data-ttu-id="80ff4-245">Создание файла конфигурации сеанса</span><span class="sxs-lookup"><span data-stu-id="80ff4-245">Create a session configuration file</span></span>](session-configurations.md)

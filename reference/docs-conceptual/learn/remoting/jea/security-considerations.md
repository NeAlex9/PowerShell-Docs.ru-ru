---
ms.date: 07/10/2019
keywords: jea,powershell,безопасность
title: Вопросы безопасности JEA
ms.openlocfilehash: befc24fec368c4f6d60477daf63bf17e9431133e
ms.sourcegitcommit: debd2b38fb8070a7357bf1a4bf9cc736f3702f31
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "70017775"
---
# <a name="jea-security-considerations"></a>Вопросы безопасности JEA

JEA помогает повысить уровень безопасности за счет сокращения числа постоянных администраторов на компьютерах. JEA использует конфигурацию сеанса PowerShell, чтобы создать новую точку входа пользователей для управления системой. Пользователи, которым требуется повышенный (но не неограниченный) уровень доступа к компьютеру для выполнения административных задач, могут получить доступ к конечной точке JEA. Поскольку JEA разрешает им запускать команды администратора без полного административного доступа, их можно удалить из высокопривилегированных групп безопасности.

## <a name="run-as-account"></a>Учетная запись запуска от имени

Каждой конечной точке JEA назначена отдельная учетная запись **запуска от имени**. Это учетная запись, от имени которой выполняются действия подключающегося пользователя. Эта учетная запись настраивается в [файле конфигурации сеанса](session-configurations.md), и ее выбор оказывает значительное влияние на безопасность конечной точки.

Рекомендуемым способом настройки учетной записи **запуска от имени** являются **виртуальные учетные записи**. Виртуальные учетные записи — это одноразовые временные локальные учетные записи, созданные для использования подключающимся пользователем во время сеанса JEA. После завершения его сеанса виртуальная учетная запись будет уничтожена, а ее дальнейшее использование станет невозможным. Подключающийся пользователь не знает учетные данные для виртуальной учетной записи. Виртуальная учетная запись не может использоваться для доступа к системе другими средствами, такими как удаленный рабочий стол или конечная точка PowerShell без ограничений.

По умолчанию виртуальные учетные записи принадлежат к локальной группе **администраторов** на компьютере. Это дает им полные права на управление всеми компонентами в системе, но не дает прав на управление ресурсами в сети.
При проверке подлинности на других компьютерах контекстом пользователя становится локальная учетная запись компьютера, а не виртуальная учетная запись.

Контроллеры домена — это особый случай, так как понятие группы локальных **администраторов** отсутствует. Вместо этого виртуальные учетные записи принадлежат роли **администраторов домена**, следовательно, используя их, можно управлять службами каталогов в контроллере домена. Использование доменного удостоверения по-прежнему ограничено контроллером домена, где инициирован сеанс JEA. Любой доступ к сети производится вместо этого от лица объекта-компьютера контроллера домена.

В обоих случаях можно явно указать, к каким группам безопасности должна принадлежать виртуальная учетная запись. Этой рекомендации стоит придерживаться, когда для задачи не требуются права локального администратора или администратора домена. Если у вас уже определена группа безопасности для администраторов, можно предоставить виртуальной учетной записи членство в этой группе. Виртуальная учетная запись ограничена локальными группами безопасности на рабочей станции или рядовом сервере. На контроллерах домена виртуальные учетные записи должны быть членами группы безопасности домена.
После добавления виртуальной учетной записи в группы безопасности она больше не принадлежит к группам по умолчанию (локальные или доменные администраторы).

В таблице ниже приведены возможные параметры и итоговые разрешения для виртуальных учетных записей.

|        Тип компьютера         | Конфигурация виртуальной учетной записи группы |                   Контекст локального пользователя                    | Контекст сетевого пользователя |
| ---------------------------- | ----------------------------------- | ------------------------------------------------------- | -------------------- |
| Контроллер домена            | Значение по умолчанию                             | Пользователь домена, член группы "*DOMAIN*\Domain Admins"         | Учетная запись компьютера     |
| Контроллер домена            | Группы доменов A и B               | Пользователь домена, член групп "*DOMAIN*\A", "*DOMAIN*\B"       | Учетная запись компьютера     |
| Рядовой сервер или рабочая станция | Значение по умолчанию                             | Локальный пользователь, член группы "*BUILTIN*\Administrators"        | Учетная запись компьютера     |
| Рядовой сервер или рабочая станция | Локальные группы C и D                | Локальный пользователь, член групп "*COMPUTER*\C" и "*COMPUTER*\D" | Учетная запись компьютера     |

При просмотре событий аудита безопасности и журналов событий приложений вы увидите, что каждый сеанс пользователя JEA имеет уникальную виртуальную учетную запись. Эта запись помогает отслеживать действия в конечной точке JEA до исходного пользователя, выполнившего команду. Имена виртуальных учетных записей соответствуют формату `WinRM Virtual Users\WinRM_VA_<ACCOUNTNUMBER>_<DOMAIN>_<sAMAccountName>`. Например, если пользователь **Alice** в домене **Contoso** перезапускает службы в конечной точке JEA, имя пользователя, связанное с любыми событиями диспетчера служб, будет иметь вид `WinRM Virtual Users\WinRM_VA_1_contoso_alice`.

**Групповые управляемые учетные записи службы (gMSA)** полезны, когда рядовому серверу требуется доступ к сетевым ресурсам в сеансе JEA. Примером может быть конечная точка JEA, используемая для управления доступом к службе REST API, размещенной на другом компьютере. Легко писать функции для вызова интерфейсов REST API, но вам потребуется сетевое удостоверение для проверки подлинности в API. Использование групповой управляемой учетной записи службы позволяет сделать "второй прыжок" и при этом управлять доступом компьютеров к этой учетной записи. Действующие разрешения учетной записи gMSA определяются группами безопасности (локальные или доменные), к которым она принадлежит.

Когда конечная точка JEA настроена для использования учетной записи gMSA, действия всех пользователей JEA относятся к одной и той же учетной записи gMSA. Единственный способ отслеживания связи действий с конкретным пользователем заключается в определении набора запущенных команд в записи сеанса PowerShell.

**Сквозные учетные данные** используются, если вы не указываете учетную запись **запуска от имени**. PowerShell использует учетные данные подключающегося пользователя для выполнения команд на удаленном сервере. Для этого вам потребуется предоставить подключающемуся пользователю прямой доступ к привилегированным группам управления. Эта настройка **не** рекомендуется для JEA. Если подключающийся пользователь уже имеет права администратора, можно отказаться от JEA и управлять системой посредством других средств, не имеющих ограничений. Дополнительные сведения см. в разделе [Отсутствие защиты от администраторов в JEA](#jea-doesnt-protect-against-admins) ниже.

**Стандартные учетные записи запуска от имени** позволяют задать любую учетную запись пользователя, с использованием которой будет выполняться весь сеанс PowerShell. Конфигурации сеанса с исправленными учетными записями **запуска от имени** (с параметром `-RunAsCredential`) не поддерживают JEA. Определения ролей больше не работают должным образом. Каждому пользователю, авторизованному для доступа к конечной точке, назначается одна и та же роль.

Не следует использовать **RunAsCredential** на конечной точке JEA из-за сложности определения связи действий с конкретными пользователями и отсутствия поддержки для сопоставления пользователей с ролями.

## <a name="winrm-endpoint-acl"></a>ACL конечной точки WinRM

Как и в случае с обычными конечными точками удаленного взаимодействия PowerShell, каждая конечная точка JEA имеет отдельный список управления доступом (ACL), который указывает, кто именно может проходить проверку подлинности на базе конечной точки JEA. При неправильной настройке доступ к конечной точке JEA может отсутствовать у доверенных пользователей и предоставляться ненадежным пользователям. ACL WinRM не влияет на сопоставление пользователей с ролями JEA. Это сопоставление регулируется полем **RoleDefinitions** в файле конфигурации сеанса, который использовался для регистрации конечной точки.

По умолчанию, когда конечная точка JEA имеет несколько возможностей ролей, ACL WinRM настраивается так, чтобы разрешить доступ всем сопоставленным пользователям. Например, сеанс JEA, настроенный с помощью указанных ниже команд, будет предоставлять полный доступ к `CONTOSO\JEA_Lev1` и `CONTOSO\JEA_Lev2`.

```powershell
$roles = @{ 'CONTOSO\JEA_Lev1' = 'Lev1Role'; 'CONTOSO\JEA_Lev2' = 'Lev2Role' }
New-PSSessionConfigurationFile -Path '.\jea.pssc' -SessionType RestrictedRemoteServer -RoleDefinitions $roles -RunAsVirtualAccount
Register-PSSessionConfiguration -Path '.\jea.pssc' -Name 'MyJEAEndpoint'
```

Можно проводить аудит разрешений пользователя с помощью командлета [Get-PSSessionConfiguration](/powershell/module/microsoft.powershell.core/get-pssessionconfiguration).

```powershell
Get-PSSessionConfiguration -Name 'MyJEAEndpoint' | Select-Object Permission
```

```Output
Permission
----------
CONTOSO\JEA_Lev1 AccessAllowed
CONTOSO\JEA_Lev2 AccessAllowed
```

Чтобы изменить пользователей, имеющих доступ, запустите `Set-PSSessionConfiguration -Name 'MyJEAEndpoint' -ShowSecurityDescriptorUI` для вывода интерактивной командной строки или `Set-PSSessionConfiguration -Name 'MyJEAEndpoint' -SecurityDescriptorSddl <SDDL string>` для изменения разрешений. Для доступа к конечной точке JEA пользователям требуется по меньшей мере права *вызова*.

Можно создать конечную точку JEA, которая не сопоставляет каждого пользователя, имеющего доступ, с определенной ролью. Такие пользователи могут запустить сеанс JEA, но имеют доступ только к командлетам по умолчанию. Можно выполнить аудит разрешений пользователя в конечной точке JEA, запустив `Get-PSSessionCapability`. Дополнительные сведения см. в разделе [Аудит и отчеты для JEA](audit-and-report.md).

## <a name="least-privilege-roles"></a>Роли, предоставляющие минимальные права

При разработке ролей JEA важно помнить о том, что виртуальная или групповая управляемая учетная запись, используемая внутри системы, часто имеет неограниченный доступ к локальному компьютеру. Возможности ролей JEA помогают ограничить набор команд и приложений, которые могут выполняться из этого привилегированного контекста.
Неправильно спроектированные роли могут разрешать запуск опасных команд, позволяющих пользователю нарушить границы JEA или получить доступ к конфиденциальной информации.

Рассмотрим, например, следующую запись возможности роли:

```powershell
@{
    VisibleCmdlets = 'Microsoft.PowerShell.Management\*-Process'
}
```

Эта возможность роли позволяет пользователям запустить любой командлет PowerShell с существительным **Process** из модуля **Microsoft.PowerShell.Management**. Пользователям может потребоваться доступ к таким командлетам, как `Get-Process`, чтобы понять, какие именно приложения запущены в системе, и `Stop-Process`, чтобы завершить приложения, которые не отвечают. Однако данная запись также разрешает `Start-Process`, который можно использовать для запуска произвольной программы с полными правами администратора. Программа не обязана быть установлена локально в системе. Подключенный пользователь может запустить программу из общей папки, где у него есть права локального администратора, выполнять вредоносные программы и многое другое.

Более безопасная версия этой же возможности роли выглядит следующим образом:

```powershell
@{
    VisibleCmdlets = 'Microsoft.PowerShell.Management\Get-Process', 'Microsoft.PowerShell.Management\Stop-Process'
}
```

Избегайте подстановочных знаков в возможностях ролей. Не забудьте регулярно проводить [аудит действующих разрешений пользователей](audit-and-report.md#check-effective-rights-for-a-specific-user), чтобы понять, какие команды доступны пользователям.

## <a name="jea-doesnt-protect-against-admins"></a>Отсутствие защиты от администраторов в JEA

Одним из основных принципов функции JEA является то, что она позволяет пользователям без прав администратора выполнять некоторые задачи администрирования. JEA не защищает от тех пользователей, кто уже обладает правами администратора. **Администраторы домена**, локальные **администраторы** или другие высокопривилегированные группы могут обойти средства защиты JEA другими средствами. Например, они могут войти в систему с помощью протокола удаленного рабочего стола, использовать удаленные консоли MMC или подключиться к конечным точкам PowerShell, не имеющим ограничений. Локальные администраторы могут также изменить конфигурацию JEA, чтобы дать доступ другим пользователям, либо изменить возможность роли, расширив область действия пользователя в своем сеансе JEA. Важно оценить расширенные разрешения пользователей JEA и попытаться определить другие способы, с помощью которых они могут получить привилегированный доступ к системе.

Распространенной практикой является использование JEA для регулярного повседневного обслуживания и наличие решения по управлению привилегированным доступом JIT, что позволяет пользователям временно становиться локальными администраторами в аварийных ситуациях. При этом пользователи не являются постоянными администраторами системы и могут получить подобные права только после завершения рабочего процесса, регулирующего использование ими таких разрешений.

---
ms.date: 06/11/2020
keywords: powershell,командлет
title: Вопросы обеспечения безопасности при удаленном взаимодействии PowerShell с использованием WinRM
description: В этом документе рассматриваются вопросы безопасности и рекомендации по использованию удаленного взаимодействия PowerShell.
ms.openlocfilehash: 48167bd297905883b3d75caf9a07d06e6a9fc467
ms.sourcegitcommit: 9080316e3ca4f11d83067b41351531672b667b7a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/24/2020
ms.locfileid: "92501479"
---
# <a name="security-considerations-for-powershell-remoting-using-winrm"></a><span data-ttu-id="140ab-104">Вопросы обеспечения безопасности при удаленном взаимодействии PowerShell с использованием WinRM</span><span class="sxs-lookup"><span data-stu-id="140ab-104">Security Considerations for PowerShell Remoting using WinRM</span></span>

<span data-ttu-id="140ab-105">Удаленное взаимодействие PowerShell — это рекомендуемый способ управления системами Windows.</span><span class="sxs-lookup"><span data-stu-id="140ab-105">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="140ab-106">В Windows Server 2012 R2 удаленное взаимодействие PowerShell включено по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="140ab-106">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="140ab-107">В этом документе рассматриваются вопросы безопасности и рекомендации по использованию удаленного взаимодействия PowerShell.</span><span class="sxs-lookup"><span data-stu-id="140ab-107">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="140ab-108">Что такое удаленное взаимодействие PowerShell?</span><span class="sxs-lookup"><span data-stu-id="140ab-108">What is PowerShell Remoting?</span></span>

<span data-ttu-id="140ab-109">Функция удаленного взаимодействия PowerShell использует службу [удаленного управления Windows (WinRM)](/windows/win32/winrm/portal), которая является реализацией протокола [веб-служб для управления (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf), чтобы дать пользователям возможность использовать команды PowerShell на удаленных компьютерах.</span><span class="sxs-lookup"><span data-stu-id="140ab-109">PowerShell Remoting uses [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="140ab-110">Дополнительные сведения об использовании удаленного взаимодействия PowerShell можно найти в статье [Выполнение удаленных команд](running-remote-commands.md).</span><span class="sxs-lookup"><span data-stu-id="140ab-110">You can find more information about using PowerShell Remoting at [Running Remote Commands](running-remote-commands.md).</span></span>

<span data-ttu-id="140ab-111">Удаленное взаимодействие PowerShell отличается от выполнения командлета с параметром **ComputerName** для запуска на удаленном компьютере, когда в качестве базового протокола используется удаленный вызов процедур (RPC).</span><span class="sxs-lookup"><span data-stu-id="140ab-111">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="140ab-112">Параметры удаленного взаимодействия PowerShell по умолчанию</span><span class="sxs-lookup"><span data-stu-id="140ab-112">PowerShell Remoting default settings</span></span>

<span data-ttu-id="140ab-113">Удаленное взаимодействие PowerShell (и WinRM) прослушивают следующие порты:</span><span class="sxs-lookup"><span data-stu-id="140ab-113">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="140ab-114">HTTP — 5985;</span><span class="sxs-lookup"><span data-stu-id="140ab-114">HTTP: 5985</span></span>
- <span data-ttu-id="140ab-115">HTTPS — 5986.</span><span class="sxs-lookup"><span data-stu-id="140ab-115">HTTPS: 5986</span></span>

<span data-ttu-id="140ab-116">По умолчанию функция удаленного взаимодействия PowerShell допускает подключения только от участников группы "Администраторы".</span><span class="sxs-lookup"><span data-stu-id="140ab-116">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span>
<span data-ttu-id="140ab-117">Сеансы запускаются в контексте пользователя, поэтому все элементы управления доступом операционной системы, примененные к отдельным пользователям и группам, продолжают применяться к ним при подключении через удаленное взаимодействие PowerShell.</span><span class="sxs-lookup"><span data-stu-id="140ab-117">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="140ab-118">В частных сетях правило брандмауэра Windows по умолчанию для удаленного взаимодействия PowerShell принимает все подключения.</span><span class="sxs-lookup"><span data-stu-id="140ab-118">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="140ab-119">В общедоступных сетях правило брандмауэра Windows по умолчанию допускает подключения удаленного взаимодействия PowerShell только из той же подсети.</span><span class="sxs-lookup"><span data-stu-id="140ab-119">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="140ab-120">Необходимо явно изменить это правило, чтобы открыть удаленное взаимодействие PowerShell для всех подключений в общедоступной сети.</span><span class="sxs-lookup"><span data-stu-id="140ab-120">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

> [!Warning]
> <span data-ttu-id="140ab-121">Правило брандмауэра для общедоступных сетей предназначено для защиты компьютера от потенциально вредоносных попыток внешних подключений.</span><span class="sxs-lookup"><span data-stu-id="140ab-121">The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="140ab-122">Будьте внимательны при удалении этого правила.</span><span class="sxs-lookup"><span data-stu-id="140ab-122">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="140ab-123">Изоляция процессов</span><span class="sxs-lookup"><span data-stu-id="140ab-123">Process isolation</span></span>

<span data-ttu-id="140ab-124">Функция удаленного взаимодействия PowerShell использует WinRM для обмена данными между компьютерами.</span><span class="sxs-lookup"><span data-stu-id="140ab-124">PowerShell Remoting uses WinRM for communication between computers.</span></span> <span data-ttu-id="140ab-125">WinRM выполняется как служба с учетной записью сетевой службы и порождает изолированные процессы, выполняющиеся как учетные записи пользователей, для размещения экземпляров PowerShell.</span><span class="sxs-lookup"><span data-stu-id="140ab-125">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="140ab-126">Экземпляр PowerShell, выполняющийся как один пользователь, не имеет доступа к процессу, в котором выполняется экземпляр PowerShell от имени другого пользователя.</span><span class="sxs-lookup"><span data-stu-id="140ab-126">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="140ab-127">Журналы событий, создаваемые удаленным взаимодействием PowerShell</span><span class="sxs-lookup"><span data-stu-id="140ab-127">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="140ab-128">Компания FireEye опубликовала хорошую сводку журналов событий и других свидетельств безопасности, создаваемых в сеансах удаленного взаимодействия PowerShell, в статье [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="140ab-128">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="140ab-129">Протоколы шифрования и транспорта</span><span class="sxs-lookup"><span data-stu-id="140ab-129">Encryption and transport protocols</span></span>

<span data-ttu-id="140ab-130">Рекомендуется оценивать безопасность подключения удаленного взаимодействия PowerShell с двух точек зрения — начальной аутентификации и текущего обмена данными.</span><span class="sxs-lookup"><span data-stu-id="140ab-130">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="140ab-131">Независимо от используемого транспортного протокола (HTTP или HTTPS), WinRM всегда шифрует все удаленное взаимодействие с PowerShell после начальной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="140ab-131">Regardless of the transport protocol used (HTTP or HTTPS), WinRM always encrypts all PowerShell remoting communication after initial authentication.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="140ab-132">Начальная проверка подлинности</span><span class="sxs-lookup"><span data-stu-id="140ab-132">Initial authentication</span></span>

<span data-ttu-id="140ab-133">Проверка подлинности используется для идентификации клиента для сервера и, в идеале, сервера для клиента.</span><span class="sxs-lookup"><span data-stu-id="140ab-133">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="140ab-134">Когда клиент подключается к серверу домена по имени компьютера, по умолчанию используется протокол аутентификации [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span><span class="sxs-lookup"><span data-stu-id="140ab-134">When a client connects to a domain server using its computer name, the default authentication protocol is [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span></span> <span data-ttu-id="140ab-135">Kerberos гарантирует идентификацию пользователя и сервера без отправки каких-либо повторно используемых учетных данных.</span><span class="sxs-lookup"><span data-stu-id="140ab-135">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="140ab-136">Если клиент подключается к серверу домена по IP-адресу (или подключается к серверу рабочей группы), проверка подлинности Kerberos невозможна.</span><span class="sxs-lookup"><span data-stu-id="140ab-136">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="140ab-137">В этом случае удаленное взаимодействие PowerShell использует [протокол аутентификации NTLM](/windows/win32/secauthn/microsoft-ntlm).</span><span class="sxs-lookup"><span data-stu-id="140ab-137">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](/windows/win32/secauthn/microsoft-ntlm).</span></span> <span data-ttu-id="140ab-138">Протокол аутентификации NTLM гарантирует идентификацию пользователя без отправки каких-либо делегируемых учетных данных.</span><span class="sxs-lookup"><span data-stu-id="140ab-138">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="140ab-139">Для подтверждения личности пользователя протокол NTLM требует, чтобы клиент и сервер вычисляли сеансовый ключ на основе пароля пользователя без передачи самого пароля.</span><span class="sxs-lookup"><span data-stu-id="140ab-139">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="140ab-140">Серверу, как правило, неизвестен пароль пользователя, поэтому он связывается с контроллером домена, которому пароль пользователя известен и который вычисляет сеансовый ключ для этого сервера.</span><span class="sxs-lookup"><span data-stu-id="140ab-140">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="140ab-141">Протокол NTLM, однако, не гарантирует идентификацию сервера.</span><span class="sxs-lookup"><span data-stu-id="140ab-141">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="140ab-142">Как и в случае с любыми протоколами, использующими NTLM для аутентификации, злоумышленник, имеющий доступ к учетной записи компьютера, присоединенного к домену, может заставить контроллер домена вычислить сеансовый ключ NTLM, тем самым олицетворяя сервер.</span><span class="sxs-lookup"><span data-stu-id="140ab-142">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="140ab-143">Проверка подлинности на основе NTLM отключена по умолчанию, но ее можно разрешить, настроив SSL на целевом сервере или настроив параметр TrustedHosts службы WinRM в клиенте.</span><span class="sxs-lookup"><span data-stu-id="140ab-143">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="140ab-144">Использование SSL-сертификатов для проверки удостоверения сервера во время NTLM-подключений</span><span class="sxs-lookup"><span data-stu-id="140ab-144">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="140ab-145">Поскольку протокол аутентификации NTLM не может гарантировать идентификацию целевого сервера (а только то, что ему уже известен ваш пароль), можно настроить на целевых серверах использование протокола SSL для удаленного взаимодействия PowerShell.</span><span class="sxs-lookup"><span data-stu-id="140ab-145">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span>
<span data-ttu-id="140ab-146">Назначение SSL-сертификата целевому серверу (если он выдан центром сертификации, которому также доверяет клиент) обеспечивает аутентификацию на основе NTLM, которая гарантирует идентификацию как пользователя, так и сервера.</span><span class="sxs-lookup"><span data-stu-id="140ab-146">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="140ab-147">Пропуск ошибок идентификации сервера на основе NTLM</span><span class="sxs-lookup"><span data-stu-id="140ab-147">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="140ab-148">Если реализация развертывания SSL-сертификата на сервере для NTLM-подключений невозможна, отключить связанные ошибки идентификации можно, добавив сервер в список **TrustedHosts** .</span><span class="sxs-lookup"><span data-stu-id="140ab-148">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="140ab-149">Обратите внимание, что добавление имени сервера в список **TrustedHosts** не должно рассматриваться как утверждение о надежности самих узлов, так как протокол аутентификации NTLM не может гарантировать, что подключение на самом деле выполняется к предполагаемому узлу.</span><span class="sxs-lookup"><span data-stu-id="140ab-149">Please note that adding a server name to the **TrustedHosts** list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span> <span data-ttu-id="140ab-150">Параметр TrustedHosts следует рассматривать как список узлов, для которых требуется отключать ошибки, возникающие из-за невозможности проверить удостоверение сервера.</span><span class="sxs-lookup"><span data-stu-id="140ab-150">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>

### <a name="ongoing-communication"></a><span data-ttu-id="140ab-151">Текущий обмен данными</span><span class="sxs-lookup"><span data-stu-id="140ab-151">Ongoing Communication</span></span>

<span data-ttu-id="140ab-152">После завершения начальной проверки подлинности WinRM выполняет шифрование всех текущих подключений.</span><span class="sxs-lookup"><span data-stu-id="140ab-152">Once initial authentication is complete, the WinRM encrypts the ongoing communication.</span></span> <span data-ttu-id="140ab-153">При подключении по протоколу HTTPS протокол TLS используется для согласования шифрования при передаче данных.</span><span class="sxs-lookup"><span data-stu-id="140ab-153">When connecting over HTTPS, the TLS protocol is used to negotiate the encryption used to transport data.</span></span>
<span data-ttu-id="140ab-154">При подключении по протоколу HTTP шифрование на уровне сообщений определяется исходя из изначального протокола проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="140ab-154">When connecting over HTTP, message-level encryption is determined by initial authentication protocol used.</span></span>

- <span data-ttu-id="140ab-155">Обычная проверка подлинности не обеспечивает шифрование.</span><span class="sxs-lookup"><span data-stu-id="140ab-155">Basic authentication provide no encryption.</span></span>
- <span data-ttu-id="140ab-156">Проверка подлинности NTLM использует шифр RC4 со 128-битным ключом.</span><span class="sxs-lookup"><span data-stu-id="140ab-156">NTLM authentication uses an RC4 cipher with a 128-bit key.</span></span>
- <span data-ttu-id="140ab-157">Шифрование проверки подлинности Kerberos определяется `etype` в билете TGS.</span><span class="sxs-lookup"><span data-stu-id="140ab-157">Kerberos authentication encryption is determined by the `etype` in the TGS ticket.</span></span> <span data-ttu-id="140ab-158">Это AES-256 в современных системах.</span><span class="sxs-lookup"><span data-stu-id="140ab-158">This is AES-256 on modern systems.</span></span>
- <span data-ttu-id="140ab-159">В шифровании CredSSP используется набор шифров TLS, который был согласован в подтверждении связи.</span><span class="sxs-lookup"><span data-stu-id="140ab-159">CredSSP encryption is uses the TLS cipher suite that was negotiated in the handshake.</span></span>

## <a name="making-the-second-hop"></a><span data-ttu-id="140ab-160">Выполнение второго перехода</span><span class="sxs-lookup"><span data-stu-id="140ab-160">Making the second hop</span></span>

<span data-ttu-id="140ab-161">По умолчанию удаленное взаимодействие PowerShell использует для проверки подлинности протокол Kerberos (по возможности) или NTLM.</span><span class="sxs-lookup"><span data-stu-id="140ab-161">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="140ab-162">Оба эти протокола выполняют проверку подлинности на удаленном компьютере без отправки учетных данных.</span><span class="sxs-lookup"><span data-stu-id="140ab-162">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span> <span data-ttu-id="140ab-163">Это наиболее безопасный способ проверки подлинности, но поскольку удаленный компьютер не имеет учетных данных пользователя, он не может получать доступ к другим компьютерам и службам от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="140ab-163">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span> <span data-ttu-id="140ab-164">Эту ситуацию называют "проблемой второго прыжка".</span><span class="sxs-lookup"><span data-stu-id="140ab-164">This is known as the "second hop problem".</span></span>

<span data-ttu-id="140ab-165">Существует несколько способов избежать ее.</span><span class="sxs-lookup"><span data-stu-id="140ab-165">There are several ways to avoid this problem.</span></span> <span data-ttu-id="140ab-166">Описание этих способов, а также преимущества и недостатки каждого из них см. в разделе [Выполнение второго прыжка при удаленном взаимодействии PowerShell](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="140ab-166">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>

## <a name="references"></a><span data-ttu-id="140ab-167">Ссылки</span><span class="sxs-lookup"><span data-stu-id="140ab-167">References</span></span>

- [<span data-ttu-id="140ab-168">Удаленное управление Windows (WinRM)</span><span class="sxs-lookup"><span data-stu-id="140ab-168">Windows Remote Management (WinRM)</span></span>](/windows/win32/winrm/portal)
- [<span data-ttu-id="140ab-169">Веб-службы для управления (WS-Management)</span><span class="sxs-lookup"><span data-stu-id="140ab-169">Web Services for Management (WS-Management)</span></span>](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)
- [<span data-ttu-id="140ab-170">Типы зашифрованных сообщений 2.2.9.1</span><span class="sxs-lookup"><span data-stu-id="140ab-170">2.2.9.1 Encrypted Message Types</span></span>](/openspecs/windows_protocols/ms-wsmv/58421aa4-861a-4410-831a-c999f094cdb7)
- [<span data-ttu-id="140ab-171">Kerberos</span><span class="sxs-lookup"><span data-stu-id="140ab-171">Kerberos</span></span>](/windows/win32/secauthn/microsoft-kerberos)
- [<span data-ttu-id="140ab-172">Протокол проверки подлинности NTLM</span><span class="sxs-lookup"><span data-stu-id="140ab-172">NTLM authentication protocol</span></span>](/windows/win32/secauthn/microsoft-ntlm)
- [<span data-ttu-id="140ab-173">Расследование атак через PowerShell</span><span class="sxs-lookup"><span data-stu-id="140ab-173">Investigating PowerShell Attacks</span></span>](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)

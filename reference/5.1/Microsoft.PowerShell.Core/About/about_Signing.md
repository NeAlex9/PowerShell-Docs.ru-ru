---
description: Описывает, как подписывать сценарии, чтобы они соответствовали политикам выполнения PowerShell.
keywords: powershell,командлет
Locale: en-US
ms.date: 07/31/2020
online version: https://docs.microsoft.com/powershell/module/microsoft.powershell.core/about/about_signing?view=powershell-5.1&WT.mc_id=ps-gethelp
schema: 2.0.0
title: about_Signing
ms.openlocfilehash: 8eada7e85b6f970a5ba4c6e1714ee598cf768706
ms.sourcegitcommit: 021ea294327dec542ec040619dac0d2171397a90
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/29/2020
ms.locfileid: "97804152"
---
# <a name="about-signing"></a>О подписывании

## <a name="short-description"></a>Краткое описание
Описывает, как подписывать сценарии, чтобы они соответствовали политикам выполнения PowerShell.

## <a name="long-description"></a>Подробное описание

Политика ограниченного выполнения не позволяет запускать скрипты. Политики выполнения **AllSigned** и **RemoteSigned** запрещают PowerShell выполнять сценарии, не имеющие цифровой подписи.

В этом разделе объясняется, как выполнить выбранные сценарии, которые не подписаны, даже если политика выполнения **RemoteSigned** и как подписывать сценарии для собственного использования.

Дополнительные сведения о политиках выполнения PowerShell см. в разделе [about_Execution_Policies](about_Execution_Policies.md).

## <a name="to-permit-signed-scripts-to-run"></a>Разрешение выполнения подписанных сценариев

При первом запуске PowerShell на компьютере, скорее всего, действует политика **ограниченного** выполнения (по умолчанию).

Политика с **ограниченным доступом** не позволяет запускать скрипты.

Чтобы найти действующую политику выполнения на компьютере, введите:

```powershell
Get-ExecutionPolicy
```

Чтобы запустить неподписанные скрипты, написанные на локальном компьютере и подписанные скрипты от других пользователей, запустите PowerShell с параметром Запуск от имени администратора, а затем используйте следующую команду, чтобы изменить политику выполнения на компьютере на **RemoteSigned**:

```powershell
Set-ExecutionPolicy RemoteSigned
```

Дополнительные сведения см. в разделе справки по `Set-ExecutionPolicy` командлету.

## <a name="running-unsigned-scripts-using-the-remotesigned-execution-policy"></a>Выполнение неподписанных скриптов с помощью политики выполнения RemoteSigned

Если политика выполнения PowerShell — **RemoteSigned**, PowerShell не будет запускать неподписанные сценарии, которые будут скачаны из Интернета, в том числе неподписанные сценарии, получаемые через электронную почту и программы обмена мгновенными сообщениями.

При попытке запустить скачанный скрипт PowerShell выводит следующее сообщение об ошибке:

```Output
The file <file-name> cannot be loaded. The file <file-name> is not digitally
signed. The script will not execute on the system. Please see "Get-Help
about_Signing" for more details.
```

Перед выполнением скрипта проверьте код, чтобы убедиться, что он является доверенным.
Сценарии имеют тот же результат, что и любая исполняемая программа.

Чтобы выполнить неподписанный скрипт, используйте командлет Unblock-File или выполните следующую процедуру.

1. Сохраните файл скрипта на своем компьютере.
2. Нажмите кнопку Пуск, выберите пункт Мой компьютер и перейдите к сохраненному файлу скрипта.
3. Щелкните правой кнопкой мыши файл скрипта и выберите пункт Свойства.
4. Нажмите кнопку Снять блокировку.

Если сценарий, скачанный из Интернета, имеет цифровую подпись, но вы еще не выбрали доверие к издателю, PowerShell выводит следующее сообщение:

```Output
Do you want to run software from this untrusted publisher?
The file <file-name> is published by CN=<publisher-name>. This
publisher is not trusted on your system. Only run scripts
from trusted publishers.

[V] Never run  [D] Do not run  [R] Run once  [A] Always run
[?] Help (default is "D"):
```

Если вы доверяете издателю, выберите "запустить один раз" или "всегда запускать". Если вы не доверяете издателю, выберите параметр "никогда не запускать" или "не запускать". Если выбрать параметр "никогда не запускать" или "всегда запускать", PowerShell не будет выводить запрос для этого издателя снова.

## <a name="methods-of-signing-scripts"></a>Методы подписания скриптов

Вы можете подписывать скрипты, которые вы пишете, и скрипты, получаемые из других источников. Перед тем как подписать любой сценарий, проверьте каждую команду, чтобы убедиться в том, что он является надежным для выполнения.

Рекомендации по подписывания кода см. в статье рекомендации по [подписывания](/previous-versions/windows/hardware/design/dn653556(v=vs.85))кода.

Дополнительные сведения о том, как подписать файл скрипта, см. в разделе [Set-AuthenticodeSignature](xref:Microsoft.PowerShell.Security.Set-AuthenticodeSignature).

`New-SelfSignedCertificate`Командлет, представленный в модуле PKI в PowerShell 3,0, создает самозаверяющий сертификат, подходящий для тестирования. Дополнительные сведения см. в разделе справки по командлету New-SelfSignedCertificate.

Чтобы добавить цифровую подпись в скрипт, необходимо подписать его с помощью сертификата подписи кода. Для подписи файла скрипта подходят два типа сертификатов:

- Сертификаты, созданные центром сертификации. для платной платы общедоступный центр сертификации проверяет ваше удостоверение и предоставляет сертификат подписи кода. При приобретении сертификата от известного центра сертификации можно предоставить общий доступ к сценарию пользователям на других компьютерах под управлением Windows, так как эти компьютеры доверяют центру сертификации.

- Создаваемые сертификаты: можно создать самозаверяющий сертификат, для которого компьютер является центром сертификации, который создает сертификат. Этот сертификат предоставляется бесплатно и позволяет писать, подписывать и выполнять сценарии на компьютере. Однако сценарий, подписанный самозаверяющим сертификатом, не будет выполняться на других компьютерах.

Как правило, самозаверяющий сертификат используется только для подписывания сценариев, написанных для собственного использования, и для подписывания сценариев, получаемых из других источников, которые были проверены как надежные. Он не подходит для сценариев, которые будут совместно использоваться даже в рамках предприятия.

При создании самозаверяющего сертификата обязательно включите усиленную защиту закрытого ключа в сертификате. Это не позволит вредоносным программам подписывать сценарии от вашего имени. Инструкции включены в конце этого раздела.

## <a name="create-a-self-signed-certificate"></a>Создание самозаверяющего сертификата.

Чтобы создать самозаверяющий сертификат, используйте `New-SelfSignedCertificate` командлет в модуле PKI. Этот модуль появился в PowerShell 3,0 и входит в Windows 8 и Windows Server 2012. Дополнительные сведения см. в разделе справки по `New-SelfSignedCertificate` командлету.

Чтобы создать самозаверяющий сертификат в более ранних версиях Windows, используйте средство создания сертификатов `MakeCert.exe` . Это средство входит в состав пакета SDK для Microsoft .NET (версии 1,1 и более поздних) и в Microsoft Windows SDK.

Дополнительные сведения о синтаксисе и описания параметров средства MakeCert.exe см. в разделе [средство создания сертификатов (MakeCert.exe)](/previous-versions/dotnet/netframework-2.0/bfsktky3(v=vs.80)).

Чтобы использовать средство MakeCert.exe для создания сертификата, выполните следующие команды в окне командной строки пакета SDK.

Примечание. Первая команда создает локальный центр сертификации для компьютера. Вторая команда создает личный сертификат из центра сертификации.

Примечание. Вы можете скопировать или ввести команды в том виде, в каком они отображаются. Подстановки не требуются, хотя имя сертификата можно изменить.

```powershell
makecert -n "CN=PowerShell Local Certificate Root" -a sha1 `
-eku 1.3.6.1.5.5.7.3.3 -r -sv root.pvk root.cer `
-ss Root -sr localMachine

makecert -pe -n "CN=PowerShell User" -ss MY -a sha1 `
-eku 1.3.6.1.5.5.7.3.3 -iv root.pvk -ic root.cer
```

Средство MakeCert.exe предложит ввести пароль для закрытого ключа. Пароль гарантирует, что никто не сможет использовать сертификат или получить к нему доступ без вашего согласия.
Создайте и введите пароль, который вы можете запомнить. Этот пароль будет использоваться позже для получения сертификата.

Чтобы убедиться, что сертификат создан правильно, выполните следующую команду, чтобы получить сертификат в хранилище сертификатов на компьютере. Файл сертификата не будет найден в каталоге файловой системы.

В командной строке PowerShell введите следующую команду:

```powershell
Get-ChildItem cert:\CurrentUser\my -codesigning
```

Эта команда использует поставщик сертификата PowerShell для просмотра сведений о сертификате.

Если сертификат создан, в выходных данных отображается **отпечаток** , который определяет сертификат в дисплее, похожем на следующий:

```Output
Directory: Microsoft.PowerShell.Security\Certificate::CurrentUser\My

Thumbprint                                Subject
----------                                -------
4D4917CB140714BA5B81B96E0B18AAF2C4564FDF  CN=PowerShell User ]
```

## <a name="sign-a-script"></a>Подписать сценарий

После создания самозаверяющего сертификата можно подписывать сценарии. Если вы используете политику выполнения **AllSigned** , подписывание сценария позволяет запустить сценарий на компьютере.

Следующий пример скрипта `Add-Signature.ps1` подписывает скрипт. Однако при использовании политики выполнения **AllSigned** необходимо подписать `Add-Signature.ps1` сценарий перед запуском.

> [!IMPORTANT]
> Скрипт должен быть сохранен с использованием кодировки ASCII или UTF8NoBOM. Вы можете подписать файл сценария, который использует другую кодировку. Но сценарий не запускается, или модуль, содержащий скрипт, не удается импортировать.

Чтобы использовать этот сценарий, скопируйте следующий текст в текстовый файл и присвойте ему имя `Add-Signature.ps1` .

```powershell
## Signs a file
param([string] $file=$(throw "Please specify a filename."))
$cert = @(Get-ChildItem cert:\CurrentUser\My -codesigning)[0]
Set-AuthenticodeSignature $file $cert
```

Чтобы подписать `Add-Signature.ps1` файл скрипта, введите в командной строке PowerShell следующие команды:

```powershell
$cert = @(Get-ChildItem cert:\CurrentUser\My -codesigning)[0]
Set-AuthenticodeSignature add-signature.ps1 $cert
```

После подписания скрипта его можно запустить на локальном компьютере. Однако сценарий не будет выполняться на компьютерах, на которых политика выполнения PowerShell требует наличия цифровой подписи от доверенного центра сертификации. При попытке PowerShell отобразится следующее сообщение об ошибке:

```Output
The file C:\remote_file.ps1 cannot be loaded. The signature of the
certificate cannot be verified.
At line:1 char:15
+ .\ remote_file.ps1 <<<<
```

Если PowerShell отображает это сообщение при выполнении скрипта, который не был написан, обработайте файл так, как если бы вы ни использовали любой неподписанный сценарий. Проверьте код, чтобы определить, можно ли доверять сценарию.

## <a name="enable-strong-private-key-protection-for-your-certificate"></a>Включение усиленной защиты закрытого ключа для сертификата

При наличии частного сертификата на компьютере вредоносные программы могут подписывать сценарии от вашего имени, что позволяет PowerShell выполнять их.

Чтобы предотвратить автоматический вход от вашего имени, используйте диспетчер сертификатов `Certmgr.exe` для экспорта сертификата подписи в `.pfx` файл. Диспетчер сертификатов входит в состав пакета SDK для Microsoft .NET, Microsoft Windows SDK и в Internet Explorer.

Чтобы экспортировать сертификат, выполните следующие действия.

1. Запустите диспетчер сертификатов.
2. Выберите сертификат, выданный корневым каталогом локального сертификата PowerShell.
3. Нажмите кнопку Экспорт, чтобы запустить мастер экспорта сертификатов.
4. Выберите "Да, экспортировать закрытый ключ" и нажмите кнопку "Далее".
5. Выберите "включить усиленную защиту".
6. Введите пароль и введите его еще раз для подтверждения.
7. Введите имя файла с расширением имени PFX-файла.
8. Нажмите кнопку «Готово».

Чтобы повторно импортировать сертификат, выполните следующие действия.

1. Запустите диспетчер сертификатов.
2. Нажмите кнопку Импорт, чтобы запустить мастер импорта сертификатов.
3. Откройте файл. pfx, созданный в процессе экспорта.
4. На странице Пароль выберите "включить усиленную защиту закрытого ключа", а затем введите пароль, назначенный в процессе экспорта.
5. Выберите хранилище личных сертификатов.
6. Нажмите кнопку «Готово».

## <a name="prevent-the-signature-from-expiring"></a>Запрет истечения срока действия подписи

Цифровая подпись в скрипте действительна до истечения срока действия сертификата подписи или до тех пор, пока сервер отметок времени не сможет проверить, подписан ли сценарий, пока сертификат для подписи был действителен.

Так как большинство сертификатов подписи действительны только в течение одного года, использование сервера отметок времени гарантирует, что пользователи смогут использовать ваш сценарий в течение многих лет.

## <a name="see-also"></a>См. также статью

[about_Execution_Policies](about_Execution_Policies.md)

[about_Profiles](about_Profiles.md)

[Get-ExecutionPolicy](xref:Microsoft.PowerShell.Security.Get-ExecutionPolicy)

[Set-ExecutionPolicy](xref:Microsoft.PowerShell.Security.Set-ExecutionPolicy)

[Set-AuthenticodeSignature](xref:Microsoft.PowerShell.Security.Set-AuthenticodeSignature)

[Знакомство с подписыванием кода](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms537361(v=vs.85))

---
description: Описание выполнения заданий на удаленных компьютерах.
keywords: powershell,командлет
Locale: en-US
ms.date: 11/11/2020
online version: https://docs.microsoft.com/powershell/module/microsoft.powershell.core/about/about_remote_jobs?view=powershell-6&WT.mc_id=ps-gethelp
schema: 2.0.0
title: about_Remote_Jobs
ms.openlocfilehash: 734bcdaea41a8c0cd589f0f31719a2069264adf3
ms.sourcegitcommit: aac365f7813756e16b59322832a904e703e0465b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2020
ms.locfileid: "94524422"
---
# <a name="about-remote-jobs"></a>Об удаленных заданиях

## <a name="short-description"></a>Краткое описание
Описание выполнения заданий на удаленных компьютерах.

## <a name="detailed-description"></a>Подробное описание

PowerShell параллельно выполняет команды и скрипты с помощью заданий. Существует три типа заданий, предоставляемых PowerShell для поддержки параллелизма.

- `RemoteJob` — Команды и скрипты выполняются в удаленном сеансе.
- `BackgroundJob` — Команды и скрипты выполняются в отдельном процессе на локальном компьютере. См. дополнительные сведения о [заданиях](about_Jobs.md).
- `PSTaskJob` или `ThreadJob` — команды и скрипты выполняются в отдельном потоке в том же процессе на локальном компьютере. Дополнительные сведения см. в разделе [about_Thread_Jobs](about_Thread_Jobs.md).

Удаленное выполнение сценариев на отдельном компьютере или в отдельном процессе обеспечивает высокую изоляцию. Любые ошибки, возникающие в удаленном задании, не влияют на другие выполняющиеся задания или родительский сеанс, запускающий задание. Однако на уровне удаленного взаимодействия добавляются дополнительные издержки, в том числе сериализация объектов. Все объекты сериализуются и десериализуются, так как они передаются между родительским сеансом и удаленным сеансом (Job). Сериализация больших сложных объектов данных может потреблять большие объемы ресурсов вычислений и памяти и передавать большие объемы данных по сети.

> [!IMPORTANT]
> Родительский сеанс, создавший задание, также отслеживает состояние задания и собирает данные конвейера. Дочерний процесс задания завершается родительским процессом после того, как задание достигнет завершенного состояния. Если родительский сеанс завершается, все выполняющиеся дочерние задания завершаются вместе с их дочерними процессами.

Существует два способа обойти эту ситуацию.

1. Используйте `Invoke-Command` для создания заданий, выполняемых в отключенных сеансах. См. раздел « [отсоединенные процессы](#how-to-run-as-a-detached-process) » этой статьи.
1. Используйте `Start-Process` для создания нового процесса, а не задания. Дополнительные сведения см. в разделе [Start-Process](xref:Microsoft.PowerShell.Management.Start-Process).

## <a name="remote-jobs"></a>Удаленные задания

Задания можно запускать на удаленных компьютерах с помощью трех различных методов.

- Запуск интерактивного сеанса на удаленном компьютере. Затем запустите задание в интерактивном сеансе. Процедуры совпадают с выполнением локального задания, хотя все действия выполняются на удаленном компьютере.

- Запуск задания на удаленном компьютере, который возвращает результаты на локальный компьютер. Используйте этот метод, если требуется получать результаты заданий и обслуживать их в центральном расположении на локальном компьютере.

- Выполнение задания на удаленном компьютере, сохраняющем результаты на удаленном компьютере. Используйте этот метод, если данные задания более безопасно поддерживаются на исходном компьютере.

### <a name="start-a-job-in-an-interactive-session"></a>Запуск задания в интерактивном сеансе

Можно запустить интерактивный сеанс с удаленным компьютером, а затем запустить задание во время интерактивного сеанса. Дополнительные сведения о интерактивных сеансах см. в разделе about_Remote и см. в разделе `Enter-PSSession` .

Процедура запуска задания в интерактивном сеансе практически идентична процедуре запуска фонового задания на локальном компьютере. Однако все операции выполняются на удаленном компьютере, а не на локальном компьютере.

1. Используйте `Enter-PSSession` командлет для запуска интерактивного сеанса с удаленным компьютером. Параметр ComputerName параметра можно использовать `Enter-PSSession` для установки временного подключения к интерактивному сеансу. Кроме того, можно использовать параметр Session для выполнения интерактивного сеанса в сеансе PowerShell (PSSession).

   Следующая команда запускает интерактивный сеанс на компьютере Server01.

   ```powershell
   C:\PS> Enter-PSSession -computername Server01
   ```

   Командная строка изменится и отобразится, что теперь вы подключены к компьютеру Server01.

   ```
   Server01\C:>
   ```

1. Чтобы запустить удаленное задание в сеансе, используйте `Start-Job` командлет. Следующая команда запускает удаленное задание, которое получает события в журнале событий Windows PowerShell на компьютере Server01. `Start-Job`Командлет возвращает объект, представляющий задание.

   Эта команда сохраняет объект задания в `$job` переменной.

   ```powershell
   Server01\C:> $job = Start-Job -scriptblock {
     Get-Eventlog "Windows PowerShell"
   }
   ```

   Во время выполнения задания можно использовать интерактивный сеанс для выполнения других команд, включая другие задания. Однако интерактивный сеанс должен быть открыт до завершения задания. Если завершить сеанс, задание будет прервано и результаты будут утеряны.

1. Чтобы узнать, завершено ли задание, отобразите значение `$job` переменной или используйте `Get-Job` командлет для получения задания. Следующая команда использует `Get-Job` командлет для вывода задания.

   ```powershell
   Server01\C:> Get-Job $job

   SessionId  Name  State      HasMoreData  Location   Command
   ---------  ----  -----      -----------  --------   -------
   1          Job1  Complete   True         localhost  Get-Eventlog "Windows...
   ```

   `Get-Job`Выходные данные показывают, что задание выполняется на компьютере "localhost", так как задание было запущено на том же компьютере (в данном случае Server01).

1. Чтобы получить результаты задания, используйте `Receive-Job` командлет. Результаты можно отобразить в интерактивном сеансе или сохранить в файл на удаленном компьютере. Следующая команда возвращает результаты задания в переменной $job. Команда использует оператор перенаправления ( `>` ) для сохранения результатов задания в файле PsLog.txt на компьютере Server01.

   ```powershell
   Server01\C:> Receive-Job $job > c:\logs\PsLog.txt
   ```

1. Чтобы завершить интерактивный сеанс, используйте `Exit-PSSession` командлет. Командная строка изменится, чтобы отобразить, что вы снова используете исходный сеанс на локальном компьютере.

   ```powershell
   Server01\C:> Exit-PSSession
   C:\PS>
   ```

1. Чтобы просмотреть содержимое `PsLog.txt` файла на компьютере Server01 в любое время, запустите другой интерактивный сеанс или выполните удаленную команду. Этот тип команды лучше выполнять в сеансе PSSession (постоянное подключение), если вы хотите использовать несколько команд для исследования и управления данными в `PsLog.txt` файле. Дополнительные сведения о PSSession см. в разделе [about_PSSessions](about_PSSessions.md).

   Следующие команды используют `New-PSSession` командлет для создания **сеанса PSSession** , подключенного к компьютеру Server01, и используют `Invoke-Command` командлет для выполнения `Get-Content` команды в PSSession для просмотра содержимого файла.

   ```powershell
   $s = New-PSSession -computername Server01
   Invoke-Command -session $s -scriptblock {
     Get-Content c:\logs\pslog.txt}
   ```

### <a name="start-a-remote-job-that-returns-the-results-to-the-local-computer-asjob"></a>Запуск удаленного задания, которое возвращает результаты на локальный компьютер (AsJob)

Чтобы запустить задание на удаленном компьютере, которое возвращает результаты команды на локальный компьютер, используйте параметр **AsJob** командлета, например `Invoke-Command` командлета.

При использовании параметра **AsJob** объект задания на самом деле создается на локальном компьютере, даже если задание выполняется на удаленном компьютере. После завершения задания результаты возвращаются на локальный компьютер.

Для управления любыми заданиями, созданными любым командлетом, можно использовать командлеты, содержащие существительное задания (командлеты задания). Многие командлеты, имеющие параметры **AsJob** , не используют удаленное взаимодействие PowerShell, поэтому их можно использовать даже на компьютерах, которые не настроены на удаленное взаимодействие и которые не соответствуют требованиям к удаленному взаимодействию.

1. Следующая команда использует параметр **AsJob** параметра `Invoke-Command` для запуска задания на компьютере Server01. Задание выполняет `Get-Eventlog` команду, которая получает события в системном журнале. Вы можете использовать параметр JobName, чтобы назначить для задания отображаемое имя.

   ```powershell
   Invoke-Command -computername Server01 -scriptblock {
     Get-Eventlog system} -AsJob
   ```

   Результаты выполнения команды похожи на приведенный ниже образец выходных данных.

   ```Output
   SessionId   Name   State    HasMoreData   Location   Command
   ---------   ----   -----    -----------   --------   -------
   1           Job1   Running  True          Server01   Get-Eventlog system
   ```

   При использовании параметра **AsJob** `Invoke-Command` возвращает тот же тип объекта задания, который `Start-Job` возвращает. Вы можете сохранить объект задания в переменной или использовать `Get-Job` команду для получения задания.

   Обратите внимание, что значение свойства Location показывает, что задание запущено на компьютере Server01.

1. Для управления заданием, запущенным с помощью параметра **AsJob** `Invoke-Command` командлета, используйте командлеты задания. Так как объект задания, представляющий удаленное задание, находится на локальном компьютере, выполнять удаленные команды для управления заданием не требуется.

   Чтобы определить, завершено ли задание, используйте `Get-Job` команду. Следующая команда возвращает все задания, запущенные в текущем сеансе.

   ```powershell
   Get-Job
   ```

   Так как удаленное задание было запущено в текущем сеансе, локальная `Get-Job` команда получает задание. Свойство State объекта Job показывает, что команда выполнена успешно.

   ```Output
   SessionId   Name   State      HasMoreData   Location   Command
   ---------   ----   -----      -----------   --------   -------
   1           Job1   Completed  True          Server01   Get-Eventlog system
   ```

1. Чтобы получить результаты задания, используйте `Receive-Job` командлет. Так как результаты задания автоматически возвращаются на компьютер, где находится объект задания, результаты можно получить с помощью локальной `Receive-Job` команды.

   Следующая команда использует `Receive-Job` командлет для получения результатов задания. Для идентификации задания используется идентификатор сеанса. Эта команда сохраняет результаты задания в переменной $results. Можно также перенаправить результаты в файл.

   ```powershell
   $results = Receive-Job -id 1
   ```

### <a name="start-a-remote-job-that-keeps-the-results-on-the-remote-computer"></a>Запуск удаленного задания, сохраняющего результаты на удаленном компьютере

Чтобы запустить задание на удаленном компьютере, сохраняющем результаты команды на удаленном компьютере, используйте `Invoke-Command` командлет для выполнения `Start-Job` команды на удаленном компьютере. Этот метод можно использовать для запуска заданий на нескольких компьютерах.

При `Start-Job` удаленном запуске команды на удаленном компьютере создается объект задания, и результаты задания сохраняются на удаленном компьютере.
С точки зрения задания все операции являются локальными. Команды выполняются удаленно для управления локальным заданием на удаленном компьютере.

1. Используйте `Invoke-Command` командлет для выполнения `Start-Job` команды на удаленном компьютере.

   Для этой команды требуется сеанс PSSession (постоянное подключение). Если `Invoke-Command` для установления временного подключения используется параметр ComputerName, `Invoke-Command` выполнение команды считается полным при возвращении объекта задания. В результате этого временное подключение закрывается и задание отменяется.

   Следующая команда использует `New-PSSession` командлет для создания сеанса PSSession, подключенного к компьютеру Server01. Команда сохраняет PSSession в `$s` переменной.

   ```powershell
   $s = New-PSSession -computername Server01
   ```

   Следующая команда использует `Invoke-Command` командлет для выполнения `Start-Job` команды в PSSession. `Start-Job`Команда и `Get-Eventlog` команда заключаются в фигурные скобки.

   ```powershell
   Invoke-Command -session $s -scriptblock {
     Start-Job -scriptblock {Get-Eventlog system}}
   ```

   Результаты похожи на приведенный ниже пример выходных данных.

   ```Output
   Id       Name    State      HasMoreData     Location   Command
   --       ----    -----      -----------     --------   -------
   2        Job2    Running    True            Localhost  Get-Eventlog system
   ```

   При `Start-Job` удаленном запуске команды `Invoke-Command` возвращает тот же тип объекта задания, который `Start-Job` возвращает. Вы можете сохранить объект задания в переменной или использовать `Get-Job` команду для получения задания.

   Обратите внимание, что значение свойства **Location** указывает на то, что задание было запущено на локальном компьютере, известном как localhost, даже если задание было запущено на компьютере Server01. Так как объект задания создается на компьютере Server01 и задание выполняется на том же компьютере, оно считается локальным фоновым заданием.

1. Для управления удаленным заданием используйте командлеты **задания** . Так как объект задания находится на удаленном компьютере, необходимо выполнить удаленные команды, чтобы получать, прекращать, ожидать или получать результаты задания.

   Чтобы узнать, завершено ли задание, используйте `Invoke-Command` команду для выполнения `Get-Job` команды в сеансе PSSession, подключенном к компьютеру Server01.

   ```powershell
   Invoke-Command -session $s -scriptblock {Get-Job}
   ```

   Команда возвращает объект задания. Свойство **State** объекта Job показывает, что команда выполнена успешно.

   ```Output
   SessionId   Name  State      HasMoreData   Location   Command
   ---------   ----  -----      -----------   --------   -------
   2           Job2  Completed  True          LocalHost   Get-Eventlog system
   ```

1. Чтобы получить результаты задания, используйте `Invoke-Command` командлет для выполнения `Receive-Job` команды в сеансе PSSession, подключенном к компьютеру Server01.

   Следующая команда использует `Receive-Job` командлет для получения результатов задания. Для идентификации задания используется идентификатор сеанса. Эта команда сохраняет результаты задания в `$results` переменной. `Receive-Job`Для сохранения результата в кэше заданий на удаленном компьютере используется параметр сохранения параметра.

   ```powershell
   $results = Invoke-Command -session $s -scriptblock {
     Receive-Job -SessionId 2 -Keep
   }
   ```

   Можно также перенаправить результаты в файл на локальном или удаленном компьютере.
   Следующая команда использует оператор перенаправления для сохранения результатов в файл на компьютере Server01.

   ```powershell
   Invoke-Command -session $s -command {
     Receive-Job -SessionId 2 > c:\logs\pslog.txt
   }
   ```

## <a name="how-to-run-as-a-detached-process"></a>Запуск как отсоединенного процесса

Как упоминалось ранее, при завершении родительского сеанса все выполняющиеся дочерние задания завершаются вместе с их дочерними процессами. Удаленное взаимодействие на локальном компьютере можно использовать для выполнения заданий, которые не подключены к текущему сеансу PowerShell.

Создайте новый сеанс PowerShell на локальном компьютере. Используется `Invoke-Command` для запуска задания в этом сеансе. `Invoke-Command` позволяет отключить удаленный сеанс и завершить родительский сеанс. Позже можно будет запустить новый сеанс PowerShell и подключиться к ранее отключенному сеансу, чтобы возобновить наблюдение за заданием. Однако при завершении этого сеанса все данные, которые были возвращены в исходный сеанс PowerShell, теряются. При повторном подключении возвращаются только новые объекты данных, созданные после отключения.

```powershell
# Create remote session on local machine
PS> $session = New-PSSession -cn localhost

# Start remote job
PS> $job = Invoke-Command -Session $session -ScriptBlock { 1..60 | % { sleep 1; "Output $_" } } -AsJob
PS> $job

Id     Name     PSJobTypeName   State         HasMoreData     Location      Command
--     ----     -------------   -----         -----------     --------      -------
1      Job1     RemoteJob       Running       True            localhost     1..60 | % { sleep 1; ...

# Disconnect the job session
PS> Disconnect-PSSession $session

Id Name         Transport ComputerName    ComputerType    State         ConfigurationName     Availability
-- ----         --------- ------------    ------------    -----         -----------------     ------------
1 Runspace1     WSMan     localhost       RemoteMachine   Disconnected  Microsoft.PowerShell          None

PS> $job

Id     Name     PSJobTypeName   State         HasMoreData     Location      Command
--     ----     -------------   -----         -----------     --------      -------
1      Job1     RemoteJob       Disconnected  True            localhost     1..60 | % { sleep 1;

# Reconnect the session to a new job object
PS> $jobNew = Receive-PSSession -Session $session -OutTarget Job
PS> $job | Wait-Job | Receive-Job
Output 9
Output 10
Output 11
...
```

В этом примере задания по-прежнему присоединяются к родительскому сеансу PowerShell.
Однако родительский сеанс не является исходным сеансом PowerShell, в котором выполнялся `Invoke-Command` .

## <a name="see-also"></a>См. также раздел

- [about_Jobs](about_Jobs.md)
- [about_Job_Details](about_Job_Details.md)
- [about_Remote](about_Remote.md)
- [about_Remote_Variables](about_Remote_Variables.md)
- [Invoke-Command](xref:Microsoft.PowerShell.Core.Invoke-Command)
- [Start-Job](xref:Microsoft.PowerShell.Core.Start-Job)
- [Get-Job.](xref:Microsoft.PowerShell.Core.Get-Job)
- [Wait-Job](xref:Microsoft.PowerShell.Core.Wait-Job)
- [Stop-Job.](xref:Microsoft.PowerShell.Core.Stop-Job)
- [Remove-Job](xref:Microsoft.PowerShell.Core.Remove-Job)
- [New-PSSession](xref:Microsoft.PowerShell.Core.New-PSSession)
- [Enter-PSSession](xref:Microsoft.PowerShell.Core.Enter-PSSession)
- [Exit-PSSession;](xref:Microsoft.PowerShell.Core.Exit-PSSession)

---
description: PowerShell регистрирует внутренние операции из подсистемы, поставщиков и командлетов.
keywords: powershell
Locale: en-US
ms.date: 03/30/2020
online version: https://docs.microsoft.com/powershell/module/microsoft.powershell.core/about/about_logging_non-windows?view=powershell-6&WT.mc_id=ps-gethelp
schema: 2.0.0
title: about_Logging_Non — Windows
ms.openlocfilehash: 402c59f839de4a2b16e2abde29e1e9cfa6be6fa7
ms.sourcegitcommit: f874dc1d4236e06a3df195d179f59e0a7d9f8436
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "93231421"
---
# <a name="about-logging-non-windows"></a>Сведения о ведении журнала, не относящемся к Windows

## <a name="short-description"></a>Краткое описание

PowerShell регистрирует внутренние операции из подсистемы, поставщиков и командлетов.

## <a name="long-description"></a>Подробное описание

PowerShell регистрирует сведения об операциях PowerShell. Например, PowerShell будет записывать в журнал такие операции, как запуск и остановка подсистемы, запуск и остановка поставщиков. В нем также будут регистрироваться сведения о командах PowerShell.

Расположение журналов PowerShell зависит от целевой платформы. В **Linux** можно использовать журналы PowerShell в **syslog** и **rsyslog. conf** . Дополнительные сведения см. в разделе локальные страницы компьютера Linux `man` . В **macOS** используется система ведения журнала **os_log** . Дополнительные сведения см. в [документации разработчика os_log](https://developer.apple.com/documentation/os/os_log).

## <a name="viewing-powershell-log-output-on-linux"></a>Просмотр выходных данных журнала PowerShell в Linux

Журналы PowerShell переносятся в **системный журнал** в Linux, а также могут использоваться все инструменты, которые обычно используются для просмотра содержимого **syslog** .

В формате записей журнала используется следующий шаблон:

```
TIMESTAMP MACHINENAME powershell[PID]: (COMMITID:TID:CID)
  [EVENTID:TASK.OPCODE.LEVEL] MESSAGE
```

|Поле        |Описание                                             |
|-------------|--------------------------------------------------------|
|`TIMESTAMP`  |Дата и время, когда была создана запись журнала.            |
|`MACHINENAME`|Имя системы, в которой был создан журнал.      |
|`PID`        |Идентификатор процесса, который написал запись журнала. |
|`COMMITID`   |`git commit`Идентификатор или тег, используемый для создания сборки.   |
|`TID`        |Идентификатор потока, который написал запись журнала.   |
|`CID`        |Шестнадцатеричный идентификатор канала записи журнала.            |
|             |10 = рабочий, 11 = аналитика                         |
|`EVENTID`    |Идентификатор события записи журнала.                  |
|`TASK`       |Идентификатор задачи для записи события                 |
|`OPCODE`     |Код операции для записи события                          |
|`LEVEL`      |Уровень ведения журнала для записи события                       |
|`MESSAGE`    |Сообщение, связанное с записью события             |

> [!NOTE]
> `EVENTID`, `TASK` , `OPCODE` и `LEVEL` являются теми же значениями, которые используются при записи в журнал событий Windows.

### <a name="filtering-powershell-log-entries-using-rsyslog"></a>Фильтрация записей журнала PowerShell с помощью rsyslog

Обычно записи журнала PowerShell записываются в системный журнал по умолчанию `location/file` . **syslog** Однако можно перенаправить записи в пользовательский файл.

1. Создайте параметр conf для конфигурации журнала PowerShell и укажите число меньше 50 (для `50-default.conf` ), например `40-powershell.conf` . Файл должен находиться в папке `/etc/rsyslog.d` .

1. Добавьте следующую запись в файл:

   ```
   :syslogtag, contains, "powershell[" /var/log/powershell.log
   & stop
   ```

1. Убедитесь `/etc/rsyslog.conf` , что включен новый файл. Часто он будет иметь универсальную инструкцию include, которая выглядит следующим образом:

   `$IncludeConfig /etc/rsyslog.d/*.conf`

   В противном случае необходимо добавить инструкцию include вручную.

1. Убедитесь, что атрибуты и разрешения заданы соответствующим образом.

   ```
   -rw-r--r-- 1 root root   67 Nov 28 12:51 40-powershell.conf
   ```

1. Задайте для свойства владение значение **root** .

   ```
   chown root:root /etc/rsyslog.d/40-powershell.conf
   ```

1. Задать разрешения на доступ: **корневой** элемент доступен для чтения и записи, **Пользователи** читают.

   ```
   chmod 644 /etc/rsyslog.d/40-powershell.conf
   ```

## <a name="viewing-powershell-log-output-on-macos"></a>Просмотр выходных данных журнала PowerShell в macOS

Самый простой способ просмотра выходных данных журнала PowerShell в macOS — использовать **консольное** приложение.

1. Найдите **консольное** приложение и запустите его.
1. Выберите имя компьютера в разделе **устройства** .
1. В поле **поиска** введите `pwsh` для основного двоичного файла PowerShell.
1. Измените фильтр поиска с `Any` на `Process` .
1. Выполните операции.
1. При необходимости сохраните Поиск для использования в будущем.

Чтобы выполнить фильтрацию по определенному экземпляру процесса PowerShell в **консоли** , ПЕРЕМЕННАЯ `$pid` содержит идентификатор процесса.

1. В поле **поиска** введите **PID** (идентификатор процесса).
1. Измените фильтр поиска на `PID` .
1. Выполните операции.

### <a name="viewing-powershell-log-output-from-a-command-line"></a>Просмотр выходных данных журнала PowerShell из командной строки

`log`Команду можно использовать для просмотра записей журнала PowerShell из командной строки.

```
sudo log stream --predicate 'process == "pwsh"' --info
```

### <a name="persisting-powershell-log-output"></a>Сохранение выходных данных журнала PowerShell

По умолчанию PowerShell использует ведение журнала только для памяти по умолчанию в macOS. Это поведение можно изменить для включения сохраняемости с помощью `log config` команды.

Следующий скрипт включает ведение журнала на уровне информации и сохраняемость:

```
log config --subsystem com.microsoft.powershell --mode=persist:info,level:info
```

Следующая команда возвращает журнал PowerShell в состояние по умолчанию:

```
log config --subsystem com.microsoft.powershell --mode=persist:default,level:default
```

После включения сохраняемости `log show` команда может использоваться для экспорта элементов журнала. Команда предоставляет параметры для экспорта последних N элементов, элементов с момента заданного времени или элементов за заданный промежуток времени.

Например, следующая команда экспортирует элементы, начиная с `9am on April 5 of 2018` :

```
log show --info --start "2018-04-05 09:00:00" --predicate "process = 'pwsh'"
```

Справку по можно получить `log` , выполнив дополнительные `log show --help` сведения.

> [!TIP]
> При выполнении любой команды журнала в командной строке или сценарии PowerShell следует использовать двойные кавычки вокруг всей строки предиката и одинарные кавычки в. Это позволяет избежать необходимости в экранировании символов двойных кавычек в строке предиката.

Также можно сохранить журналы событий в более безопасном месте, например в центральном сборщике журналов событий или [SIEM][] агрегаторе. Вы можете настроить SIEM в Azure. Дополнительные сведения см. в разделе [Универсальная интеграция SIEM](/cloud-app-security/siem).

## <a name="configuring-logging-on-a-non-windows-system"></a>Настройка ведения журнала в системе, отличной от Windows

В Windows ведение журнала настраивается путем создания прослушивателей трассировки событий Windows или с помощью Просмотр событий для включения аналитического ведения журнала. В Linux и macOS ведение журнала настраивается с помощью файла `powershell.config.json` . В оставшейся части этого раздела обсуждается настройка ведения журнала PowerShell в системе, отличной от Windows.

По умолчанию PowerShell включает информационное ведение журнала в операционный канал. Это означает, что все выходные данные журнала, созданные PowerShell, помеченные как работоспособные и имеющие уровень журнала (Trace) больше информационного уровня, будут занесены в журнал. Иногда для диагностики может потребоваться дополнительный вывод журнала, например подробный вывод журнала или включение аналитического вывода журнала.

Файл `powershell.config.json` представляет собой отформатированный **JSON** -файл, находящийся в `$PSHOME` каталоге PowerShell. Каждая установка PowerShell использует собственную копию этого файла. Для нормальной работы этот файл остается без изменений. Хотя это может быть полезно, для изменения некоторых параметров в файле для диагностики или различения нескольких версий PowerShell в одной системе или даже нескольких копиях одной и той же версии (см `LogIdentity` . в таблице ниже).

Следующий код является примером конфигурации:

```json
{
  "Microsoft.PowerShell:ExecutionPolicy": "RemoteSigned",
  "PowerShellPolicies": {
    "ScriptExecution": {
      "ExecutionPolicy": "RemoteSigned",
      "EnableScripts": true
    },
    "ScriptBlockLogging": {
      "EnableScriptBlockInvocationLogging": true,
      "EnableScriptBlockLogging": true
    },
    "ModuleLogging": {
      "EnableModuleLogging": false,
      "ModuleNames": [
        "PSReadline",
        "PowerShellGet"
      ]
    },
    "ProtectedEventLogging": {
      "EnableProtectedEventLogging": false,
      "EncryptionCertificate": [
        "Joe"
      ]
    },
    "Transcription": {
      "EnableTranscripting": true,
      "EnableInvocationHeader": true,
      "OutputDirectory": "F:\\tmp\\new"
    },
    "UpdatableHelp": {
      "DefaultSourcePath": "f:\\temp"
    },
    "ConsoleSessionConfiguration": {
      "EnableConsoleSessionConfiguration": false,
      "ConsoleSessionConfigurationName": "name"
    }
  },
  "LogLevel": "verbose"
}
```

Свойства для настройки ведения журнала PowerShell перечислены в следующей таблице. Значения, отмеченные звездочкой (например `Operational*` ,), указывают значение по умолчанию, если в файле не указано значение.

|Свойство   |Значения        |Описание                                  |
|-----------|--------------|---------------------------------------------|
|`LogIdentity`|(имя строки) |Имя, используемое при ведении журнала. По умолчанию  |
|           |оболочк   |идентификатором является PowerShell. Это значение может быть|
|           |              |используется для определения разницы между двумя      |
|           |              |экземпляры установки PowerShell, такие как |
|           |              |в качестве выпуска и бета-версии. Это значение равно |
|           |              |также используется для перенаправления выходных данных журнала в        |
|           |              |отдельный файл в Linux. См. обсуждение|
|           |              |**rsyslog** выше.                           |
|`LogChannels`|Рабочего  |Включенные каналы. Разделите значения|
|           |Аналитический      |с запятой при указании более одного параметра.  |
|`LogLevel`   |Всегда        |Укажите одно значение. Значение включает  |
|           |Критически важно      |и все значения, приведенные выше в        |
|           |Ошибка         |в списке слева.                            |
|           |Предупреждение       |                                             |
|           |Извещен|                                             |
|           |Подробный       |                                             |
|           |Отладка         |                                             |
|`LogKeywords`|Пространство выполнения      |Ключевые слова обеспечивают возможность ограничения ведения журнала|
|           |Pipeline      |для конкретных компонентов в PowerShell. на |
|           |Протокол      |по умолчанию все ключевые слова включены и изменены. |
|           |Транспорт     |Это значение полезно только для очень           |
|           |Узел          |специализированные способы устранения неполадок.                |
|           |Командлеты       |                                             |
|           |serializer    |                                             |
|           |Сеанс       |                                             |
|           |манажедплугин |                                             |

## <a name="see-also"></a>См. также статью

Сведения о **syslog** и **rsyslog. conf** для Linux см. на локальных страницах компьютера Linux `man` .

Сведения о **Os_log** macOS см. в [документации по os_log разработчиков](https://developer.apple.com/documentation/os/os_log).

[about_Logging_Windows](about_Logging_Windows.md)

[Универсальная интеграция SIEM](/cloud-app-security/siem)

<!-- link references -->
[SIEM]: https://wikipedia.org/wiki/Security_information_and_event_management

---
ms.date: 06/12/2017
keywords: jea,powershell,безопасность
title: Вопросы безопасности JEA
ms.openlocfilehash: 46ea5cc3e9bc7b6759524aa466e900950a6dee26
ms.sourcegitcommit: 54534635eedacf531d8d6344019dc16a50b8b441
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2018
ms.locfileid: "34190185"
---
# <a name="jea-security-considerations"></a>Вопросы безопасности JEA

> Область применения: Windows PowerShell 5.0

JEA помогает повысить уровень безопасности за счет сокращения числа постоянных администраторов на компьютерах.
Это достигается путем создания новой точки входа пользователей для управления системой (конфигурация сеанса PowerShell), которая по умолчанию надежно защищена от несанкционированного использования.
Пользователи, которым требуется некоторый (но не неограниченный) уровень доступа к компьютеру для выполнения административных задач, могут получить доступ к конечной точке JEA.
Поскольку JEA разрешает им запускать команды администратора без непосредственного административного доступа, их можно удалить из высокопривилегированных групп безопасности (сделав обычными пользователями).

Этот раздел подробнее описывает рекомендации и модель безопасности для JEA.

## <a name="run-as-account"></a>учетная запись запуска от имени

Каждая конечная точка JEA имеет назначенную учетную запись запуска от имени, с помощью которой выполняются действия подключающегося пользователя.
Эта учетная запись настраивается в [файле конфигурации сеанса](session-configurations.md), и ее выбор оказывает значительное влияние на безопасность конечной точки.

Рекомендуемым способом настройки учетной записи запуска от имени являются **виртуальные учетные записи**.
Виртуальные учетные записи — это одноразовые временные локальные учетные записи, созданные для использования подключающимся пользователем во время сеанса JEA.
После завершения его сеанса виртуальная учетная запись будет уничтожена, а ее дальнейшее использование станет невозможным.
Подключающийся пользователь не знает учетных данных для виртуальной учетной записи и не может использовать ее для доступа к системе другими средствами, такими как удаленный рабочий стол или конечная точка PowerShell без ограничений.

По умолчанию виртуальные учетные записи принадлежат к локальной группе администраторов на компьютере.
Это дает им полные права на управление всеми компонентами в системе, но не дает прав на управление ресурсами в сети.
При выполнении аутентификации на других компьютерах контекстом пользователя становится локальная учетная запись компьютера, а не виртуальная учетная запись.

Контроллеры домена — это особый случай, так как понятие группы локальных администраторов отсутствует.
Вместо этого виртуальные учетные записи принадлежат роли администраторов домена, следовательно, используя их, можно управлять службами каталогов в контроллере домена.
Использование идентификатора по-прежнему ограничивается контроллером домена, где инициирован сеанс JEA, когда любой доступ к сети будет отображаться как связанный с объектом компьютера контроллера домена в качестве источника.

В обоих случаях можно явно определить, к каким группам безопасности должна принадлежать виртуальная учетная запись.
Этой рекомендации стоит придерживаться, когда для выполнения задачи не требуются права локального администратора или администратора домена.
Если у вас уже определена группа безопасности для администраторов, можно просто предоставить виртуальной учетной записи членство в этой группе для назначения ей необходимых разрешений.
Виртуальная учетная запись может быть членом локальных групп безопасности на рабочей станции или рядовом сервере, но на контроллере домена она может быть только членом групп безопасности домена.
Если для виртуальной учетной записи указана одна или несколько групп безопасности, она больше не будет принадлежать к группам по умолчанию (локальный администратор или администратор домена).

В таблице ниже приведены возможные параметры и итоговые разрешения для виртуальных учетных записей:

Тип компьютера                | Конфигурация виртуальной учетной записи группы | Контекст локального пользователя                                      | Контекст сетевого пользователя
-----------------------------|-------------------------------------|---------------------------------------------------------|--------------------------------------------------
Контроллер домена            | Значение по умолчанию                             | Пользователь домена, член группы "*DOMAIN*\Domain Admins"         | Учетная запись компьютера
Контроллер домена            | Группы доменов A и B               | Пользователь домена, член групп "*DOMAIN*\A", "*DOMAIN*\B"       | Учетная запись компьютера
Рядовой сервер или рабочая станция | Значение по умолчанию                             | Локальный пользователь, член группы "*BUILTIN*\Administrators"        | Учетная запись компьютера
Рядовой сервер или рабочая станция | Локальные группы C и D                | Локальный пользователь, член групп "*COMPUTER*\C" и "*COMPUTER*\D" | Учетная запись компьютера

При просмотре событий аудита безопасности и журналов событий приложений вы увидите, что каждый сеанс пользователя JEA имеет уникальную виртуальную учетную запись.
Это помогает отслеживать действия в конечной точке JEA до исходного пользователя, выполнившего команду.
Имена виртуальных учетных записей соответствуют формату "WinRM Virtual Users\\WinRM\_VA\_*ACCOUNTNUMBER*\_*DOMAIN*\_*sAMAccountName*". Например, если пользователь "Alice" в домене "Contoso" перезапускает службы в конечной точке JEA, имя пользователя, связанное с любыми событиями диспетчера служб, будет иметь вид "WinRM Virtual Users\\WinRM\_VA\_1\_contoso\_alice".


**Групповые управляемые учетные записи службы (gMSA)** полезны, когда рядовому серверу требуется доступ к сетевым ресурсам в сеансе JEA.
Примером такого варианта применения является конечная точка JEA, используемая для управления доступом к REST API, размещенном на другом компьютере.
Написание функций для выполнения нужных вызовов REST API не вызывает сложностей, однако в целях проверки подлинности для API вам потребуется сетевое удостоверение.
Использование групповой управляемой учетной записи службы позволяет сделать "второй прыжок" и при этом управлять доступом компьютеров к этой учетной записи.
Действующие разрешения учетной записи gMSA определяются группами безопасности (локальные или доменные), к которым она принадлежит.

Когда конечная точка JEA настроена для использования учетной записи gMSA, действия всех пользователей JEA относятся к одной учетной записи gMSA.
Единственный способ установления связи действий с конкретным пользователем заключается в определении набора запущенных команд в записи сеанса PowerShell.

**Сквозные учетные данные** — если не указать учетную запись запуска от имени, PowerShell будет использовать учетные данные подключающегося пользователя для выполнения команд на удаленном сервере.
Такая конфигурация *не* является рекомендуемой для JEA, так как требует от вас предоставить подключающемуся пользователю прямой доступ к привилегированным группам управления.
Если подключающийся пользователь уже имеет права администратора, можно полностью отказаться от JEA и управлять системой посредством других средств, не имеющих ограничений.
Дополнительные сведения см. в разделе [Отсутствие защиты от администраторов в JEA](#jea-does-not-protect-against-admins) ниже.

**Стандартные учетные записи запуска от имени** позволяют задать любую учетную запись пользователя, с использованием которой будет выполняться весь сеанс PowerShell.
Это важное отличие, так как конфигурация сеанса, настроенная для использования фиксированной учетной записи запуска от имени (с помощью параметра `-RunAsCredential`), не поддерживает функции JEA.
Это означает, что определения ролей перестают работать должным образом, а каждому пользователю, авторизованному для доступа к конечной точке, будет назначаться одна и та же роль.

Не следует использовать RunAsCredential на конечной точке JEA из-за сложности определения связи действий с конкретными пользователями и отсутствия поддержки для сопоставления пользователей с ролями.

## <a name="winrm-endpoint-acl"></a>ACL конечной точки WinRM

Как и в случае с обычными конечными точками удаленного взаимодействия PowerShell, каждая конечная точка JEA имеет отдельный список управления доступом (ACL), заданный в конфигурации WinRM, который указывает, кто именно может проходить проверку подлинности на базе конечной точки JEA.
При неправильной настройке доступ к конечной точке JEA может отсутствовать у доверенных пользователей и (или) предоставляться ненадежным пользователям.
Однако ACL WinRM не влияет на сопоставление пользователей с ролями JEA.
Это регулируется полем *RoleDefinitions* в файле конфигурации сеанса, который был зарегистрирован в системе.

По умолчанию при регистрации конечной точки JEA с помощью файла конфигурации сеанса и одной или нескольких возможностей ролей ACL WinRM будет настроен для предоставления всем пользователям сопоставления с одной или несколькими ролями для доступа к конечной точке.
Например, сеанс JEA, настроенный с помощью указанных ниже команд, будет предоставлять полный доступ к *CONTOSO\JEA\_Lev1* и *CONTOSO\JEA\_Lev2*.

```powershell
$roles = @{ 'CONTOSO\JEA_Lev1' = 'Lev1Role'; 'CONTOSO\JEA_Lev2' = 'Lev2Role' }
New-PSSessionConfigurationFile -Path '.\jea.pssc' -SessionType RestrictedRemoteServer -RoleDefinitions $roles -RunAsVirtualAccount
Register-PSSessionConfiguration -Path '.\jea.pssc' -Name 'MyJEAEndpoint'
```

Можно проводить аудит разрешений пользователя с помощью командлета [Get-PSSessionConfiguration](https://msdn.microsoft.com/powershell/reference/5.1/microsoft.powershell.core/get-pssessionconfiguration).

```powershell
PS C:\> Get-PSSessionConfiguration -Name 'MyJEAEndpoint' | Select-Object Permission

Permission
----------
CONTOSO\JEA_Lev1 AccessAllowed
CONTOSO\JEA_Lev2 AccessAllowed
```

Чтобы изменить пользователей, имеющих доступ, запустите `Set-PSSessionConfiguration -Name 'MyJEAEndpoint' -ShowSecurityDescriptorUI` для вывода интерактивной командной строки или `Set-PSSessionConfiguration -Name 'MyJEAEndpoint' -SecurityDescriptorSddl <SDDL string>` для изменения разрешений.
Для доступа к конечной точке JEA пользователям требуется по меньшей мере права *вызова*.

Если дополнительные пользователи получают доступ к конечной точке JEA, но не соответствуют ни одной роли, определенной в файле конфигурации сеанса, они смогут запустить сеанс JEA, но при этом использовать только командлеты по умолчанию.
Можно выполнить аудит разрешений пользователя в конечной точке JEA, запустив `Get-PSSessionCapability`.
Ознакомьтесь со статьей [Аудит и отчеты для JEA](audit-and-report.md) для получения дополнительных сведений об аудите команд, к которым пользователь имеет доступ в конечной точке JEA.

## <a name="least-privilege-roles"></a>Роли, предоставляющие минимальные права

При разработке ролей JEA важно помнить о том, что виртуальная или групповая управляемая учетная запись, используемая внутри системы, часто имеет неограниченный доступ к функциям управления локальным компьютером.
Возможности ролей JEA помогают сузить сферу применения учетной записи, ограничив число команд и приложений, которые могут выполняться, с использованием этого привилегированного контекста.
Неправильно спроектированные роли могут разрешать запуск опасных команд, позволяющих пользователю нарушить границы JEA или получить доступ к конфиденциальной информации.

Рассмотрим, например, следующую запись возможности роли:

```powershell
@{
    VisibleCmdlets = 'Microsoft.PowerShell.Management\*-Process'
}
```

Эта возможность роли позволяет пользователям запустить любой командлет PowerShell с существительным "Process" из модуля Microsoft.PowerShell.Management.
Пользователям может потребоваться доступ к таким командлетам, как `Get-Process`, чтобы понять, какие именно приложения запущены в системе, и `Stop-Process`, чтобы завершить зависшие приложения.
Однако данная запись также разрешает `Start-Process`, который можно использовать для запуска произвольной программы с полными правами администратора.
Так как локальная установка программы не требуется, злоумышленник может просто запустить из общего файлового ресурса программу, предоставляющую подключающемуся пользователю права локального администратора, запускающая вредоносное ПО и выполняющая многие другие операции.

Более безопасная версия этой же возможности роли выглядит следующим образом:

```powershell
@{
    VisibleCmdlets = 'Microsoft.PowerShell.Management\Get-Process', 'Microsoft.PowerShell.Management\Stop-Process'
}
```

Избегайте использования подстановочных знаков в возможностях ролей и не забудьте регулярно проводить [аудит действующих разрешений пользователя](audit-and-report.md#check-effective-rights-for-a-specific-user), чтобы понять, какие команды доступны пользователю.

## <a name="jea-does-not-protect-against-admins"></a>Отсутствие защиты от администраторов в JEA

Одним из основных принципов функции JEA является то, что она позволяет пользователям без прав администратора выполнять *некоторые* задачи администрирования.
JEA не защищает от тех пользователей, кто уже обладает правами администратора.
Пользователи, входящие в группу администраторов домена, локальных администраторов, или другие высокопривилегированные группы в вашей среде могут обойти средства защиты JEA, выполнив вход на компьютер другими средствами.
Например, они могут войти в систему с помощью протокола удаленного рабочего стола, использовать удаленные консоли MMC или подключиться к конечным точкам PowerShell, не имеющим ограничений.
Локальные администраторы также могут изменить конфигурацию JEA, чтобы разрешить другим пользователям управлять системой, либо изменить возможность роли, расширив область действия пользователя в своем сеансе JEA.
Поэтому важно оценить расширенные разрешения пользователей JEA и попытаться определить другие способы, с помощью которых они могут получить привилегированный доступ к системе.

Распространенной практикой является использование JEA для регулярного повседневного обслуживания и наличие решения по управлению привилегированным доступом "JIT", что позволяет пользователям временно становиться локальными администраторами в аварийных ситуациях.
При этом пользователи не являются постоянными администраторами системы и могут получить подобные права только после завершения рабочего процесса, регулирующего использование ими таких разрешений.
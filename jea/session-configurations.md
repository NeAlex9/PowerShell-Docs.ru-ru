---
ms.date: 06/12/2017
keywords: jea,powershell,безопасность
title: Конфигурации сеансов JEA
ms.openlocfilehash: 1b598522d43b2c1a26a739a67cee5181b21a7c32
ms.sourcegitcommit: 548547b2d5fc73e726bb9fec6175d452a351d975
ms.translationtype: MTE95
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2018
ms.locfileid: "53655469"
---
# <a name="jea-session-configurations"></a>Конфигурации сеансов JEA

> Применяется к: Windows PowerShell 5.0

Конечная точка JEA регистрируется в системе путем создания и регистрации файла конфигурации сеанса PowerShell особым образом.
Конфигурации сеансов определяют, *кто* может использовать конечную точку JEA и к каким ролям он будет иметь доступ.
Они также определяют глобальные параметры, которые применяются к пользователям с любой ролью в сеансе JEA.

Этот раздел описывает, как создать файл конфигурации сеанса PowerShell и зарегистрировать конечную точку JEA.

## <a name="create-a-session-configuration-file"></a>Создание файла конфигурации сеанса

Чтобы зарегистрировать конечную точку JEA, следует указать способ ее настройки.
При этом следует учитывать множество параметров. Наиболее важные из них — кто должен иметь доступ к конечной точке JEA, какие роли будут назначаться этим пользователям, какое удостоверение будет использоваться внутри JEA, а также какое имя будет иметь конечная точка JEA.
Все они определяются в файле конфигурации сеанса PowerShell, который представляет собой файл данных PowerShell с расширением PSSC.

Чтобы создать каркасный файл конфигурации сеанса для конечных точек JEA, выполните указанную ниже команду.

```powershell
New-PSSessionConfigurationFile -SessionType RestrictedRemoteServer -Path .\MyJEAEndpoint.pssc
```

> [!TIP]
> По умолчанию каркасный файл включает только основные параметры конфигурации.
> Чтобы включить в создаваемый PSSC-файл все применимые настройки, используйте параметр `-Full`.

Файл конфигурации сеанса можно открыть в любом текстовом редакторе.
Поле `-SessionType RestrictedRemoteServer` указывает, что конфигурация сеанса будет использоваться JEA для безопасного управления.
Настроенные таким образом сеансы работают в [режиме NoLanguage](https://technet.microsoft.com/library/dn433292.aspx) и содержат только восемь следующих команд (и псевдонимов) по умолчанию:

- Clear-Host (cls, clear)
- Exit-PSSession (exsn, exit)
- Get-Command (gcm)
- Get-FormatData
- Get-Help
- Measure-Object (measure)
- Out-Default
- Select-Object (select)

Поставщики PowerShell недоступны, как и внешние программы (исполняемые файлы, скрипты и т. д.).

Существует несколько полей, которые потребуется настроить для сеанса JEA.
Они описаны в следующих разделах.

### <a name="choose-the-jea-identity"></a>Выбор удостоверения JEA

Для выполнения команд подключенных пользователей JEA требуется удостоверение (учетная запись).
Задать используемое JEA удостоверение можно в файле конфигурации сеанса.

#### <a name="local-virtual-account"></a>Локальная виртуальная учетная запись

Если роли, поддерживаемые этой конечной точкой JEA, используются для управления локальным компьютером, а для успешного выполнения команд достаточно учетной запись локального администратора, следует настроить JEA для использования локальной виртуальной учетной записи.
Виртуальные учетные записи — это временные записи, уникальные для определенного пользователя, срок действия которых ограничен длительностью его сеанса PowerShell.
На рядовом сервере или рабочей станции виртуальные учетные записи принадлежат к группе **Администраторы** локального компьютера и обладают доступом к большинству системных ресурсов.
На контроллере домена Active Directory виртуальные учетные записи принадлежат к группе **Администраторы домена** домена.

```powershell
# Setting the session to use a virtual account
RunAsVirtualAccount = $true
```

Если ролям, включенным в конфигурацию сеанса, не требуются такие широкие права, можно дополнительно указать группы безопасности, к которым будет принадлежать виртуальная учетная запись.
На рядовом сервере или рабочей станции указанные группы безопасности должны быть локальными, а не из домена.

Если указана одна или несколько групп безопасности, виртуальная учетная запись больше не будет принадлежать к группе локальных администраторов или администраторов домена.

```powershell
# Setting the session to use a virtual account that only belongs to the NetworkOperator and NetworkAuditor local groups
RunAsVirtualAccount = $true
RunAsVirtualAccountGroups = 'NetworkOperator', 'NetworkAuditor'
```
> [!NOTE]
> Виртуальные учетные записи временно предоставляются вход качестве службы в политике безопасности на локальном сервере.  Если один из VirtualAccountGroups указан уже предоставлено это право в политике, отдельных виртуальная учетная запись будет больше не добавляются и удаляются из политики.  Это может быть полезно в сценариях, таких как контроллеры домена, где тесно аудит изменения политики безопасности контроллера домена.  Эта возможность доступна только в Windows Server 2016 с ноября 2018 года или более поздней версии свертки и 2019 Windows Server с января 2019 или более поздней версии накопительного пакета.

#### <a name="group-managed-service-account"></a>Групповая управляемая учетная запись службы


В сценариях, где пользователю JEA требуется доступ к сетевым ресурсам, например другим компьютерам или веб-службам, наиболее подходящим удостоверением является групповая управляемая учетная запись службы (gMSA).
Групповые управляемые учетные записи службы предоставляют удостоверение домена, которое можно использовать для проверки подлинности с использованием ресурсов на любом компьютере в домене.
Права, предоставляемые учетной записью gMSA, зависят от тех ресурсов, к которым вы обращаетесь.
Вы не будете автоматически получать права администратора на компьютерах или в службах, пока администратор компьютера или службы явно не предоставит учетной записи gMSA права администратора.

```powershell
# Configure JEA sessions to use the gMSA account in the local computer's domain with the sAMAccountName of 'MyJEAgMSA'
GroupManagedServiceAccount = 'Domain\MyJEAgMSA'
```

Учетные записи gMSA следует использовать только тогда, когда по нескольким причинам требуется доступ к сетевым ресурсам:

- При использовании учетной записи gMSA труднее установить связь действий с пользователем, так как каждый пользователь использует одно удостоверение запуска от имени. Для сопоставления пользователей с действиями потребуется обратиться к записям сеанса и журналам PowerShell.

- Учетная запись gMSA может иметь доступ к различным ресурсам сети, обращаться к которым подключающемуся пользователю не требуется. Всегда старайтесь ограничить действующие разрешения в рамках сеанса JEA и следуйте принципу предоставления минимальных прав.

> [!NOTE]
> Групповые управляемые учетные записи доступны только в Windows PowerShell 5.1 или более поздней версии и на компьютерах, присоединенных к домену.


#### <a name="more-information-about-run-as-users"></a>Дополнительные сведения о запуске от имени

Дополнительные сведения об удостоверениях запуска от имени и их роли в обеспечении безопасности сеанса JEA можно найти в статье [Вопросы безопасности](security-considerations.md).

### <a name="session-transcripts"></a>Записи сеансов

Рекомендуется настроить файл конфигурации сеанса JEA для автоматической записи сеансов пользователей.
Записи сеансов PowerShell содержат сведения о подключающемся пользователе, назначенном ему удостоверении запуска от имени и выполняемых им командах.
Их удобно использовать для аудита группы, когда необходимо знать, кто именно внес определенное изменение в систему.

Чтобы настроить автоматическую запись в файле конфигурации сеанса, укажите путь к папке, где должны храниться записи.

```powershell
TranscriptDirectory = 'C:\ProgramData\JEAConfiguration\Transcripts'
```

Указанная папка должна быть настроена так, чтобы запретить пользователям изменять ее или удалять в ней данные.
Записи помещаются в папку с учетной записью Local System, которой требуются права на чтение и запись в каталоге.
У обычных пользователей не должно быть доступа к этой папке, а ограниченный набор администраторов безопасности должен иметь такой доступ для аудита записей.

### <a name="user-drive"></a>Диск пользователя

Если подключающимся пользователям потребуется скопировать файлы с конечной точки JEA или на нее для выполнения команды, можно включить диск пользователя в файле конфигурации сеанса.
Диск пользователя — это [PSDrive](https://msdn.microsoft.com/powershell/scripting/getting-started/cookbooks/managing-windows-powershell-drives), сопоставленный с уникальной папкой каждого подключающегося пользователя.
Эта папка служит для копирования файлов из системы и в нее без назначения пользователям прав доступа ко всей файловой системе или предоставления поставщика FileSystem.
Содержимое диска пользователя сохраняется между сеансами на случай, если сетевое подключение будет прервано.

```powershell
MountUserDrive = $true
```

По умолчанию этот диск позволяет хранить до 50 МБ данных на пользователя.
Вы можете ограничить объем данных, доступных пользователю, с помощью поля *UserDriveMaximumSize*.

```powershell
# Enables the user drive with a per-user limit of 500MB (524288000 bytes)
MountUserDrive = $true
UserDriveMaximumSize = 524288000
```

Если хранить данные на диске пользователя не требуется, можно настроить в системе запланированное задание, автоматически очищающее папку каждую ночь.

> [!NOTE]
> Диск пользователя доступен только в Windows PowerShell 5.1 или более поздней версии.

### <a name="role-definitions"></a>Определения ролей

Определения ролей в файле конфигурации сеанса определяют сопоставление *пользователей* с *ролями*.
Все пользователи или группы, включенные в это поле, автоматически получат разрешение на конечную точку JEA после ее регистрации.
Пользователя или группу можно включить в качестве ключа в хэш-таблицу только один раз, однако им можно назначить несколько ролей.
Имя возможности роли должно соответствовать имени файла возможности роли без расширения PSRC.

```powershell
RoleDefinitions = @{
    'CONTOSO\JEA_DNS_ADMINS'    = @{ RoleCapabilities = 'DnsAdmin', 'DnsOperator', 'DnsAuditor' }
    'CONTOSO\JEA_DNS_OPERATORS' = @{ RoleCapabilities = 'DnsOperator', 'DnsAuditor' }
    'CONTOSO\JEA_DNS_AUDITORS'  = @{ RoleCapabilities = 'DnsAuditor' }
}
```

Если пользователь принадлежит к нескольким группам в определении роли, они получат доступ к ролям в каждой из них.
Если две роли предоставляют доступ к одним командлетам, пользователю назначается наиболее нестрогий набор параметров.

При указании локальных пользователей и группы в поле определения роли перед обратной косой чертой обязательно укажите имя компьютера (не *localhost* или *.*).
Чтобы проверить имя компьютера, проверьте имя переменной `$env:computername`.

```powershell
RoleDefinitions = @{
    'MyComputerName\MyLocalGroup' = @{ RoleCapabilities = 'DnsAuditor' }
}
```

### <a name="role-capability-search-order"></a>Порядок поиска возможностей ролей
Как показано в приведенном выше примере, ссылка на возможности ролей осуществляется по плоскому имени (имя без расширения) файла возможностей ролей.
Если несколько возможностей ролей доступны в системе с одинаковым плоским именем, PowerShell использует неявный порядок поиска для выбора действующего файла возможностей ролей.
При этом система **не** предоставляет доступ всем файлам возможностей ролей с одинаковым именем.

JEA использует переменную `$env:PSModulePath` среды, чтобы определить искомые пути для файлов возможностей роли.
В пределах каждого из этих путей JEA будет искать допустимые модули PowerShell, которые содержат вложенную папку RoleCapabilities.
Как и при импорте модулей JEA использует возможности роли, доступные в Windows, а не пользовательские возможности роли с тем же именем.
При всех других конфликтах имен приоритет определяется порядком, в котором Windows перечисляет файлы в каталоге (не обязательно в алфавитном порядке).
Первый найденный файл возможности роли, соответствующий нужному имени, будет использоваться для подключающегося пользователя.

Порядок, в котором выполняется поиск возможностей роли, не является детерминированным. Поэтому если два или несколько наборов возможностей роли имеют одинаковые имена, **настоятельно рекомендуется** присвоить возможностям роли уникальные имена на компьютере.

### <a name="conditional-access-rules"></a>Правила условного доступа

Все пользователи и группы, включенные в поле RoleDefinitions, автоматически получают доступ к конечным точкам JEA.
Правила условного доступа позволяют уточнить такой доступ и потребовать от пользователей принадлежности к дополнительным группам безопасности, не оказывающим влияния на роли, которым они назначены.
Это может быть полезно, если требуется интегрировать решение управления привилегированным доступом "JIT", проверку подлинности смарт-карт или другое решение многофакторной проверки подлинности с помощью JEA.

Правила условного доступа определяются в поле RequiredGroups файла конфигурации сеанса.
Там можно задать хэш-таблицу (при необходимости вложенной), которая использует ключи "And" и "Or" для создания правил.
Ниже представлены примеры использования этого поля.

```powershell
# Example 1: Connecting users must belong to a security group called "elevated-jea"
RequiredGroups = @{ And = 'elevated-jea' }

# Example 2: Connecting users must have signed on with 2 factor authentication or a smart card
# The 2 factor authentication group name is "2FA-logon" and the smart card group name is "smartcard-logon"
RequiredGroups = @{ Or = '2FA-logon', 'smartcard-logon' }

# Example 3: Connecting users must elevate into "elevated-jea" with their JIT system and have logged on with 2FA or a smart card
RequiredGroups = @{ And = 'elevated-jea', @{ Or = '2FA-logon', 'smartcard-logon' }}
```

> [!NOTE]
> Правила условного доступа доступны только в Windows PowerShell 5.1 или более поздней версии.

### <a name="other-properties"></a>Другие свойства
Файлы конфигурации сеанса позволяют выполнять те же операции, что и файл возможностей ролей, за исключением предоставления подключающимся пользователям доступа к другим командам.
Если вы хотите разрешить всем пользователям доступ к определенным командлетам, функциям или поставщикам, это можно сделать прямо в файле конфигурации сеанса.
Чтобы вывести полный список поддерживаемых свойств в файле конфигурации сеанса, запустите `Get-Help New-PSSessionConfigurationFile -Full`.

## <a name="testing-a-session-configuration-file"></a>Проверка файла конфигурации сеанса

Конфигурацию сеанса можно проверить с помощью командлета [Test-PSSessionConfigurationFile](https://msdn.microsoft.com/powershell/reference/5.1/microsoft.powershell.core/test-pssessionconfigurationfile).
Настоятельно рекомендуется проверить файл конфигурации сеанса после редактирования PSSC-файла вручную с помощью текстового редактора, чтобы убедиться в правильности синтаксиса.
Если файл конфигурации сеанса не проходит эту проверку, его не удастся успешно зарегистрировать в системе.

## <a name="sample-session-configuration-file"></a>Пример файла конфигурации сеанса

Ниже приведен полноценный пример, показывающий, как создать и проверить конфигурацию сеанса для JEA.
Обратите внимание, что для удобства использования и чтения определения роли создаются и хранятся в переменной `$roles`.
Это не является обязательным.

```powershell
$roles = @{
    'CONTOSO\JEA_DNS_ADMINS'    = @{ RoleCapabilities = 'DnsAdmin', 'DnsOperator', 'DnsAuditor' }
    'CONTOSO\JEA_DNS_OPERATORS' = @{ RoleCapabilities = 'DnsOperator', 'DnsAuditor' }
    'CONTOSO\JEA_DNS_AUDITORS'  = @{ RoleCapabilities = 'DnsAuditor' }
}

New-PSSessionConfigurationFile -SessionType RestrictedRemoteServer -Path .\JEAConfig.pssc -RunAsVirtualAccount -TranscriptDirectory 'C:\ProgramData\JEAConfiguration\Transcripts' -RoleDefinitions $roles -RequiredGroups @{ Or = '2FA-logon', 'smartcard-logon' }
Test-PSSessionConfigurationFile -Path .\JEAConfig.pssc # should yield True
```

## <a name="updating-session-configuration-files"></a>Изменение файлов конфигурации сеанса

Если необходимо изменить свойства конфигурации сеанса JEA, включая сопоставление пользователей с ролями, следует [отменить регистрацию](register-jea.md#unregistering-jea-configurations) конфигурации сеанса JEA и [повторно зарегистрировать ее](register-jea.md).
В случае повторной регистрации конфигурации сеанса JEA используйте обновленный файл конфигурации сеанса PowerShell, включающий нужные изменения.

## <a name="next-steps"></a>Дальнейшие действия

- [Регистрация конфигурации JEA](register-jea.md)
- [Создание ролей JEA](role-capabilities.md)
